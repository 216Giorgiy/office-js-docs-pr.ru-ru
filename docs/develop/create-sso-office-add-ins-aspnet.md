# <a name="create-an-aspnet-office-add-in-that-uses-single-sign-on"></a>Создание такой надстройки Office на платформе ASP.NET, для которой используется единый вход

После того как пользователи войдут в Office, ваша надстройка сможет использовать те же учетные данные для предоставления им доступа к нескольким приложениям без необходимости повторного входа. Общие сведения см. в статье [Включение единого входа в надстройке Office](../../docs/develop/sso-in-office-add-ins.md).

Из этой статьи вы узнаете, как включить единый вход в надстройке, созданной с помощью ASP.NET, OWIN и MSAL для .NET.

> **Примечание.** Аналогичная статья, посвященная надстройке на основе Node.js, — [Создание надстройки Office на платформе Node.js с использованием единого входа](../../docs/develop/create-sso-office-add-ins-nodejs.md).

## <a name="prerequisites"></a>Необходимые компоненты

* Последняя доступная версия Visual Studio 2017 Preview.

>**Примечание.** На данный момент последняя версия Visual Studio 2017 Preview несовместима со схемой манифеста надстройки, необходимой для единого входа. Сведения о том, как обойти это ограничение, приведены ниже.

* Office 2016 версии 1708 (сборка 8424.nnnn) или более поздней версии (версия подписки Office 365, иногда называемая нажми и работай). Чтобы скачать эту версию, вам может потребоваться принять участие в программе предварительной оценки Office. Дополнительные сведения см. в статье [Примите участие в программе предварительной оценки Office](https://products.office.com/en-us/office-insider?tab=tab-1).

## <a name="set-up-the-starter-project"></a>Настройка начального проекта

1. Клонируйте или скачайте репозиторий [Office Add-in ASPNET SSO](https://github.com/officedev/office-add-in-aspnet-sso).

1. Перейдите в папку **Before** и откройте SLN-файл в Visual Studio. Это начальный проект. Пользовательский интерфейс и другие аспекты надстройки, не связанные непосредственно с единым входом и авторизацией, уже готовы.

    > Примечание. В том же репозитории также есть готовая версия примера. Она идентична надстройке, которую вы бы создали, выполнив процедуры из этой статьи, за тем исключением, что готовый проект содержит комментарии к коду. В них нет необходимости, если вы читаете эту статью. Чтобы использовать готовую версию, просто откройте SLN-файл и выполните действия, описанные в этой статье, пропустив разделы **Код на стороне клиента** и **Код на стороне сервера**.

1. Открыв проект, выполните его сборку в Visual Studio. При этом будут установлены пакеты, указанные в файле packages.config. Это может занять от пары секунд до нескольких минут в зависимости от того, сколько пакетов хранится в локальном кэше пакетов на компьютере.

    > **Важно!** В файле packages.config из корневого каталога проекта веб-API указывается версия `1.1.1-alpha0393` Microsoft.Identity.Client (библиотеки MSAL). После первого нажатия клавиши F5 убедитесь, что установлена эта (или более поздняя) версия. В меню **Сервис** выберите **Диспетчер пакетов Nuget** > **Управление пакетами Nuget для решения** > **Установлено**. Прокрутите список до **Microsoft.Identity.Client**, чтобы просмотреть установленную версию. Если она более ранняя, чем `1.1.1-alpha0393` (или отсутствует в списке **Установлено**), выберите **Диспетчер пакетов Nuget** > **Консоль диспетчера пакетов**. В консоли выполните команду `Install-Package Microsoft.Identity.Client -Version 1.1.1-alpha0393 -Source https://www.myget.org/F/aad-clients-nightly/api/v3/index.json`.

1. После полной сборки проекта нажмите клавишу F5. Откроется PowerPoint, где на ленте **Главная** появится группа **SSO ASP.NET**.

1. Нажмите кнопку **Show add-in** (Показать надстройку) в этой группе, чтобы увидеть пользовательский интерфейс надстройки в области задач. Кнопка в области задач пока что не работает.
2. Остановите отладчик в Visual Studio.

## <a name="register-the-add-in-with-azure-ad-v20-endpoint"></a>Регистрация надстройки в конечной точке Azure AD версии 2.0

1. Перейдите на страницу [https://apps.dev.microsoft.com/](https://apps.dev.microsoft.com).

1. Войдите в клиент Office 365, используя учетные данные администратора. Пример: MyName@contoso.onmicrosoft.com

1. Нажмите **Добавить приложение**.

1. Укажите имя приложения Office-Add-in-ASPNET-SSO и нажмите **Создать приложение**.

1. Когда откроется страница настройки, скопируйте и сохраните **идентификатор приложения**. Он понадобится вам позже.

    > **Примечание.** Этот идентификатор представляет собой значение аудитории, используемое, когда другие приложения, например ведущее приложение Office (PowerPoint, Word, Excel и т. д.), пытаются получить авторизованный доступ к вашему приложению. Кроме того, он используется как идентификатор клиента, когда приложение, в свою очередь, пытается получить авторизованный доступ к Microsoft Graph.

1. В разделе **Секреты приложения** нажмите **Создать новый пароль**. Откроется всплывающее диалоговое окно с новым паролем (его также называют секретом приложения). *Сразу скопируйте пароль и сохраните его вместе с идентификатором приложения.* Он понадобится вам позже. Затем закройте диалоговое окно.

1. В разделе **Платформы** нажмите **Добавление платформы**.

1. В открывшемся диалоговом окне выберите **Веб-API**.

1. Будет создан **URI идентификатора приложения** в формате "api://{GUID кода приложения}". Вставьте строку localhost:44355/ между двойной косой чертой и GUID. Полный идентификатор должен выглядеть следующим образом: `api://localhost:44355/{App ID GUID}`. (Доменная часть имени в поле **Область** под **URI идентификатора приложения** автоматически изменится соответствующим образом. Она должна выглядеть так: `api://localhost:44355/{App ID GUID}/access_as_user`.)

1. В разделе **Предварительно авторизованные приложения** укажите приложения, которые необходимо авторизовать для веб-приложения надстройки. Необходимо обеспечить предварительную авторизацию для всех указанных ниже идентификаторов. После ввода каждого из них будет появляться новое пустое текстовое поле. (Введите только GUID.)
 * `d3590ed6-52b3-4102-aeff-aad2292ab01c` (Microsoft Office).
 * `57fb890c-0dab-4253-a5e0-7188c88b2bb4` (Office Online).
 * `bc59ab01-8403-45c6-8796-ac3ef710b3e3` (Office Online).

1. Откройте раскрывающийся список **Область** рядом с каждым полем **Идентификатор приложения** и установите флажок `api://localhost:44355/{App ID GUID}/access_as_user`.

1. В верхней части раздела **Платформы** снова нажмите кнопку **Добавление платформы** и выберите **Веб**.

1. В новом подразделе **Веб** раздела **Платформы** введите следующий **URL-адрес перенаправления**: `https://localhost:44355`.

    > Примечание. На момент написания этой статьи платформа **Веб-API** иногда исчезает из раздела **Платформы**, особенно после обновления страницы после добавления платформы **Веб** *и сохранения страницы регистрации*. Чтобы убедиться, что платформа **Веб-API** все еще используется при регистрации, нажмите кнопку **Изменить манифест приложения** в нижней части страницы. В свойстве **identifierUris** манифеста должна отображаться строка `api://localhost:44355/{App ID GUID}`. Кроме того, должно отображаться свойство **oauth2Permissions**, для подсвойства **value** которого задано значение `access_as_user`.

1. Прокрутите вниз до подраздела **Делегированные разрешения** в разделе **Разрешения Microsoft Graph**. Нажмите кнопку **Добавить**, чтобы открыть диалоговое окно **Выбор разрешения**.

1. В диалоговом окне установите флажки указанных ниже разрешений (некоторые из них могут быть установлены по умолчанию). Для надстройки требуется только первое разрешение, а `offline_access` и `openid` требуются для библиотеки MSAL, используемой серверным кодом. Разрешение `profile` необходимо, чтобы ведущее приложение Office получило токен для веб-приложения надстройки.
 * Files.Read.All
 * offline_access
 * openid
 * profile

1. Нажмите кнопку **ОК** в нижней части диалогового окна.

1. Нажмите кнопку **Сохранить** в нижней части страницы регистрации.

## <a name="grant-admin-consent-to-the-add-in"></a>Предоставление надстройке согласия администратора

> **Примечание.** Эту процедуру необходимо выполнять только при разработке надстройки. После развертывания рабочей надстройки в Магазине Office или каталоге надстроек будет два варианта развития событий. В первом случае пользователи сделают ее доверенной в индивидуальном порядке, во втором — администратор во время установки предоставит свое согласие для всей организации.

1. Если надстройка не запущена в Visual Studio, нажмите клавишу **F5**, чтобы запустить ее. Она должна быть запущена в IIS, чтобы эта процедура прошла успешно.

1. В строке `https://login.microsoftonline.com/common/adminconsent?client_id={application_ID}&state=12345` замените заполнитель {application_ID} идентификатором приложения, скопированным во время регистрации надстройки.

1. Вставив полученный URL-адрес в адресную строку браузера, перейдите по нему.

1. Войдите в область клиентов Office 365, используя учетные данные администратора.

1. Затем вам будет предложено предоставить надстройке разрешение на доступ к данным Microsoft Graph. Нажмите **Принять**.

1. После этого окно или вкладка браузера будут перенаправлены на **URL-адрес перенаправления**, указанный при регистрации надстройки, поэтому в браузере откроется домашняя страница надстройки.

2. В адресной строке браузера вы увидите параметр запроса tenant со значением GUID. Это идентификатор вашего клиента Office 365. Скопируйте и сохраните это значение. Оно понадобится вам позже.

3. Закройте окно или вкладку.

1. Остановите отладчик в Visual Studio.

## <a name="configure-the-add-in"></a>Конфигурация надстройки

1. В приведенной ниже строке замените заполнитель {tenant_ID} на полученный ранее идентификатор клиента Office 365. Если по той или иной причине вы не получили идентификатор ранее, используйте один из способов, описанных в статье [Поиск идентификатора клиента Office 365](https://support.office.com/en-us/article/Find-your-Office-365-tenant-ID-6891b561-a52d-4ade-9f39-b492285e2c9b).

    `https://login.microsoftonline.com/{tenant_ID}/v2.0`

1. В Visual Studio откройте файл web.config. В разделе **appSettings** есть ключи, которым необходимо назначить значения.

1. Используйте строку, составленную на шаге 1, в качестве значения ключа ida:Issuer. Убедитесь, что в значении нет пробелов.

1. Введите указанные ниже значения для соответствующих ключей.

|Ключ|Значение|
|:-----|:-----|
|ida:ClientID|Идентификатор приложения, полученный во время регистрации надстройки.|
|ida:Audience|Идентификатор приложения, полученный во время регистрации надстройки.|
|ida:Password|Пароль, который вы получили во время регистрации надстройки.|


Ниже показан пример того, как должны выглядеть четыре измененные вами ключа. *Обратите внимание на то, что значения ClientID и Audience совпадают*. Вы также можете использовать один ключ для обеих целей, но код web.config будет проще повторно использовать, если вы разделите их, так как они не всегда будут одинаковыми. Кроме того, наличие отдельных ключей позволяет считать вашу надстройку как ресурсом OAuth, связанным с ведущим приложением Office, так и клиентом OAuth, связанным с Microsoft Graph.

    ```xml
    <add key=”ida:ClientID" value="12345678-1234-1234-1234-123456789012" />
    <add key="ida:Audience" value="12345678-1234-1234-1234-123456789012" />
    <add key="ida:Password" value="rFfv17ezsoGw5XUc0CDBHiU" />
    <add key="ida:Issuer" value="https://login.microsoftonline.com/aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee/v2.0" />
    ```

> **Примечание.** Оставьте остальные параметры в разделе **appSettings** без изменений.

1. Сохраните и закройте файл.

1. В проекте надстройки откройте файл манифеста Office-Add-in-ASPNET-SSO.xml.

1. Перейдите в конец кода файла.

1. Над закрывающим тегом `</VersionOverrides>` вы найдете следующую часть кода:

    ```xml
    <WebApplicationInfo>
      <Id>{application_GUID here}</Id>
      <Resource>api://localhost:44355/{application_GUID here}<Resource>
      <Scopes>
          <Scope>Files.Read.All</Scope>
          <Scope>offline_access</Scope>
          <Scope>openid</Scope>
          <Scope>profile</Scope>
      </Scopes>
    </WebApplicationInfo>
    ```

1. Замените заполнитель {application_GUID here} *в обоих местах* кода идентификатором приложения, скопированным во время регистрации надстройки. Символы {} не входят в состав идентификатора, их не нужно вставлять. Это тот же идентификатор, который использовался для ClientID и Audience в файле web.config.

    > **Примечание.**
    >* Значение **Resource** представляет собой **универсальный код ресурса (URI) для идентификатора приложения**, который вы задали, когда добавляли платформу веб-API при регистрации надстройки.
    >* Раздел **Scopes** используется только для создания диалогового окна согласия, если предполагается продавать надстройку в Магазине Office.

1. Откройте вкладку **Предупреждения** в **списке ошибок** в Visual Studio. Если на ней есть предупреждение о том, что `<WebApplicationInfo>` не является допустимым дочерним элементом узла `<VersionOverrides>`, это означает, что используемой вами версии Visual Studio 2017 Preview не удается распознать разметку единого входа. В качестве обходного решения в надстройке Word, Excel или PowerPoint можно выполнить указанные ниже действия. Если вы работаете с надстройкой Outlook, вы найдете решение ниже.

   - **Обходное решение для Word, Excel и Powerpoint**

   > 1. Закомментируйте раздел `<WebApplicationInfo>` в манифесте прямо перед завершением узла `</VersionOverrides>`.

   > 2. Нажмите клавишу F5, чтобы запустить сеанс отладки. В результате будет создана копия манифеста в следующей папке (доступ к которой проще получить в **проводнике**, чем в Visual Studio): `Office-Add-in-ASP.NET-SSO\Complete\Office-Add-in-ASPNET-SSO\bin\Debug\OfficeAppManifests`

   > 3. В копии манифеста удалите синтаксис комментария для раздела `<WebApplicationInfo>`.

   > 4. Сохраните копию манифеста.

   > 5. Теперь необходимо принять меры, чтобы не допустить перезаписи копии манифеста в Visual Studio при следующем нажатии клавиши F5. Щелкните правой кнопкой мыши узел решения в самом верху **обозревателя решений** (именно этот, а не узел одного из проектов).

   > 6. В контекстном меню выберите пункт **Свойства**. Откроется диалоговое окно **Страницы свойств решения**.

   > 7. Разверните пункт **Свойства конфигурации** и щелкните **Конфигурация**.

   > 8. Снимите флажки **Выполнить сборку** и **Развернуть** в строке для проекта **Office-Add-in-ASPNET-SSO** (но *не* проекта **Office-Add-in-ASPNET-SSO-WebAPI**).

   > 9. Закройте диалоговое окно, нажав кнопку **ОК**.

   - **Обходное решение для Outlook**

   > 1. Найдите файл `MailAppVersionOverridesV1_1.xsd` на компьютере, используемом для разработки. Он должен находиться в том каталоге, в котором установлена среда Visual Studio, в папке `./Xml/Schemas/{lcid}`. Например, при обычной установке 32-разрядной версии VS 2017 в системе, где используется английский язык (США), полный путь будет выглядеть так: `C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\Xml\Schemas\1033`.

   > 2. Измените имя существующего файла на `MailAppVersionOverridesV1_1.old`.

   > 3. Скопируйте измененную версию файла в папку: [Измененная схема MailAppVersionOverrides](https://github.com/OfficeDev/outlook-add-in-attachments-demo/blob/sso-conversion/manifest-schema-fix/MailAppVersionOverridesV1_1.xsd)

1. Сохраните и закройте главный файл манифеста в Visual Studio.

## <a name="code-the-client-side"></a>Написание кода для клиента

1. Откройте файл Home.js в папке **Scripts**. В нем уже есть следующий код:
    * Назначение методу `Office.initialize`, которое, в свою очередь, назначает обработчик события для нажатия кнопки `getGraphAccessTokenButton`.
    * Метод `showResult` для отображения данных, возвращаемых из Microsoft Graph (или сообщения об ошибке), в нижней части области задач.

1. Под назначением методу `Office.initialize` добавьте приведенный ниже код. Вот что нужно знать об этом коде:

    * `getAccessTokenAsync` — это новый API в Office.js, позволяющий надстройке запрашивать у ведущего приложения Office (Excel, PowerPoint, Word и т. д.) маркер доступа к надстройке (для пользователя, выполнившего вход в Office). Ведущее приложение Office, в свою очередь, запрашивает маркер у конечной точки Azure AD 2. Так как вы предварительно авторизовали ведущее приложение Office для надстройки во время ее регистрации, Azure AD отправит маркер.
    * Если вход в Office не выполнен, ведущее приложение Office предложит пользователю войти.
    * Параметр настроек задает для свойства `forceConsent` значение false, поэтому пользователю не будет предложено разрешить ведущему приложению Office доступ к надстройке.

    ```js
    function getOneDriveFiles() {
        getDataWithToken({ forceConsent: false });
    }

    function getDataWithToken(options) {
        Office.context.auth.getAccessTokenAsync(options,
            function (result) {
                if (result.status === "succeeded") {
                    TODO1: Use the access token to get Microsoft Graph data.
                }
                else {
                    console.log("Code: " + result.error.code);
                    console.log("Message: " + result.error.message);
                    console.log("name: " + result.error.name);
                    document.getElementById("getGraphAccessTokenButton").disabled = true;
                }
            });
    }
    ```

1. Замените строку TODO1 на приведенные ниже строки. Метод `getData` и серверный маршрут /api/values создаются позже. Для конечной точки используется относительный URL-адрес, так как она должна размещаться на том же домене, что и надстройка.

    ```js
    accessToken = result.value;
    getData("/api/values", accessToken);
    ```

1. Под методом `getOneDriveFiles` добавьте приведенный ниже код. Этот служебный метод вызывает указанную конечную точку веб-API и передает ей тот же маркер доступа, который ведущее приложение Office использовало для доступа к надстройке. На стороне сервера этот маркер доступа будет использоваться в потоке "от имени" для получения маркера доступа к Microsoft Graph.

    ```js
    function getData(relativeUrl, accessToken) {
        $.ajax({
            url: relativeUrl,
            headers: { "Authorization": "Bearer " + accessToken },
            type: "GET",
        })
        .done(function (result) {
            showResult(result);
        })
        .fail(function (result) {
            TODO2: Handle errors and the case where Microsoft Graph
                   requires additional form of authentication.
        });
    }
    ```

1. Замените TODO2 приведенным ниже кодом. Обратите внимание на следующие особенности этого кода:

    * Если ошибка связана с тем, что для Microsoft Graph требуется дополнительная форма проверки подлинности, `exceptionMessage` будет строкой JSON, содержащей "capolids". В этом случае ведущему приложению Office необходимо получить новый токен.  
    * Сообщение об исключении указывает AAD на необходимость отобразить для пользователя запрос на все требуемые проверки подлинности. По этой причине оно должно быть передано ведущему приложению Office. Последнее, в свою очередь, передаст это сообщение службе AAD, когда та запросит новый токен.
    * Параметр `authChallenge` — это метод передачи этой строки ведущему приложению Office.
    * Если ошибка — это не запрос на дополнительную проверку подлинности, она будет зарегистрирована в консоли.

    ```js
    var exceptionMessage = JSON.parse(result.responseText).ExceptionMessage;
    if (exceptionMessage.indexOf("capolids") !== -1) {
        getDataWithToken({ authChallenge: exceptionMessage });
    } else {
        console.log(result.error);
    }
    ```

1. Сохраните и закройте файл.

## <a name="code-the-server-side"></a>Код на стороне сервера

### <a name="configure-the-owin-middleware"></a>Настройка ПО промежуточного слоя OWIN

1. Откройте файл Startup.cs в корневой папке проекта.

1. Добавьте ключевое слово `partial` в объявление класса Startup, если его там еще нет. Оно должно выглядеть так:

    `public partial class Startup`

1. Добавьте приведенную ниже строку в текст метода `Configuration`. Метод `ConfigureAuth` создается позже.

    `ConfigureAuth(app);`

1. Сохраните и закройте файл.

1. Щелкните правой кнопкой мыши папку **App_Start** и выберите **Добавить > Класс**.

1. В диалоговом окне **Добавить новый элемент** введите имя файла **Startup.Auth.cs** и нажмите кнопку **Добавить**.

1. Сократите имя пространства имен в новом файле до `Office_Add_in_ASPNET_SSO_WebAPI`.

1. Убедитесь, что в начале файла есть все приведенные ниже операторы `using`.

    ```
    using Owin;
    using System.IdentityModel.Tokens;
    using System.Configuration;
    using Microsoft.Owin.Security.OAuth;
    using Microsoft.Owin.Security.Jwt;
    using Office_Add_in_ASPNET_SSO_WebAPI.App_Start;
    ```

1. Добавьте ключевое слово `partial` в объявление класса `Startup`, если его там еще нет. Оно должно выглядеть так:

    `public partial class Startup`

1. Добавьте приведенный ниже метод в класс `Startup`. Этот метод указывает, как ПО промежуточного слоя OWIN будет проверять маркеры доступа, передаваемые ему из метода `getData` в файле Home.js на стороне клиента. Процесс вызывается при каждом вызове конечной точки веб-API, содержащей атрибут `[Authorize]`.

    ```
    public void ConfigureAuth(IAppBuilder app)
    {
        // TODO3: Configure the validation settings
        // TODO4: Specify the type of authorization and the discovery endpoint
        // of the secure token service.
    }
    ```

1. Замените TODO3 приведенным ниже кодом. Примечание.

    * Код сообщает OWIN о необходимости убедиться, что аудитория и поставщик маркера, указанные в маркере доступа из ведущего приложения Office (который передается путем вызова метода `getData` на стороне клиента), должны совпадать со значениями, указанными в файле web.config.
    * Если задать для свойства `SaveSigninToken` значение `true`, OWIN сохранит необработанный маркер из ведущего приложения Office. Он необходим надстройке, чтобы получить маркер доступа к Microsoft Graph в потоке "от имени".
    * ПО промежуточного слоя OWIN не проверяет области. Области маркера доступа, которые должны включать `access_as_user`, проверяются в контроллере.

    ```
    var tvps = new TokenValidationParameters
        {
            ValidAudience = ConfigurationManager.AppSettings["ida:Audience"],
            ValidIssuer = ConfigurationManager.AppSettings["ida:Issuer"],
            SaveSigninToken = true
        };
    ```

1. Замените TODO4 приведенным ниже кодом. Примечание.

    * Метод `UseOAuthBearerAuthentication` вызывается вместо более распространенного метода `UseWindowsAzureActiveDirectoryBearerAuthentication`, так как последний несовместим с конечной точкой Azure AD версии 2.
    * ПО промежуточного слоя OWIN использует URL-адрес обнаружения, передаваемый методу, чтобы получить ключ, необходимый для проверки подписи в маркере доступа, полученном из ведущего приложения Office.

    ```
    app.UseOAuthBearerAuthentication(new OAuthBearerAuthenticationOptions
            {
                AccessTokenFormat = new JwtFormat(tvps, new OpenIdConnectCachingSecurityTokenProvider("https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration"))
            });
    ```

1. Сохраните и закройте файл.

### <a name="create-the-apivalues-controller"></a>Создание контроллера /api/values

1. Откройте файл **Controllers\ValueController.cs**.

2. Убедитесь, что в начале файла есть приведенные ниже инструкции с `using`.

    ```
    using Microsoft.Identity.Client;
    using System;
    using System.IdentityModel.Tokens;
    using System.Collections.Generic;
    using System.Configuration;
    using System.Linq;
    using System.Security.Claims;
    using System.Threading.Tasks;
    using System.Web;
    using System.Web.Http;
    using Office_Add_in_ASPNET_SSO_WebAPI.Helpers;
    using Office_Add_in_ASPNET_SSO_WebAPI.Models;
    ```

3. Над строкой, в которой объявляется `ValuesController`, добавьте атрибут `[Authorize]`. Благодаря этому надстройка будет запускать процесс авторизации, настроенный во время выполнения последней процедуры, при каждом вызове метода контроллера. Вызывать методы контроллера могут только стороны с действительным маркером доступа для надстройки.

4. Добавьте следующий метод для `ValuesController`:

    ```
    // GET api/values
    public async Task<IEnumerable<string>> Get()
    {
        // TODO5: Validate the scopes of the access token.
    }
    ```

5. Замените TODO5 приведенным ниже кодом, чтобы убедиться в том, что `access_as_user` включена в области, указанные в токене.

    ```
    string[] addinScopes = ClaimsPrincipal.Current.FindFirst("http://schemas.microsoft.com/identity/claims/scope").Value.Split(' ');
    if (addinScopes.Contains("access_as_user"))
    {
        // TODO6: Assemble all the information that is needed to get a token for Microsoft Graph using the "on behalf of" flow.
        // TODO7: Get the access token for Microsoft Graph.
        // TODO8: Get the names of files and folders in OneDrive by using the Microsoft Graph API.
        // TODO9: Remove excess information from the data and send the data to the client.
    }
    return new string[] { "Error", "Microsoft Office does not have permission to get Microsoft Graph data on behalf of the current user." };
    ```

> **Примечание.** Для авторизации API, который отвечает за поток выполнения от имени другого субъекта, в случае надстроек Office используйте только область `access_as_user`. Для других API в службе должны быть предусмотрены отдельные требования, касающиеся областей. Это ограничивает доступ, предоставляемый с использованием токенов, которые получает Office.

6. Замените TODO6 приведенным ниже кодом. Примечание.
    * Код преобразует необработанный маркер доступа, полученный от ведущего приложения Office, в объект `UserAssertion`, который будет передан другому методу.
    * Надстройка больше не выступает в роли ресурса (или аудитории), доступ к которому необходим ведущему приложению Office и пользователю. Теперь она сама является клиентом, которому необходим доступ к Microsoft Graph. `ConfidentialClientApplication` — это объект "контекста клиента" MSAL.
    * Третий параметр конструктора `ConfidentialClientApplication` — URL-адрес перенаправления. На самом деле он не используется в потоке "от имени", но все равно рекомендуется указывать правильный URL-адрес. С помощью четвертого и пятого параметров можно определить постоянное хранилище, которое позволяет повторно использовать действительные маркеры в разных сеансах с надстройкой. В этом примере не реализуется постоянное хранилище.
    * Для работы библиотеки MSAL требуются области `openid` и `offline_access`, но если код их избыточно запрашивает, возникает ошибка. Кроме того, ошибка возникнет, если код запросит `profile` (фактически используется только при получении ведущим приложением Office токена для веб-приложения надстройки). Поэтому явным образом запрашивается только `Files.Read.All`.

    ```
    var bootstrapContext = ClaimsPrincipal.Current.Identities.First().BootstrapContext as BootstrapContext;
    UserAssertion userAssertion = new UserAssertion(bootstrapContext.Token);
    ClientCredential clientCred = new ClientCredential(ConfigurationManager.AppSettings["ida:Password"]);
    ConfidentialClientApplication cca =
                    new ConfidentialClientApplication(ConfigurationManager.AppSettings["ida:ClientID"],
                                                      "https://localhost:44355", clientCred, null, null);
    string[] graphScopes = { "Files.Read.All" };
    ```

7. Замените TODO7 приведенным ниже кодом. Примечание.

    * Для начала метод `ConfidentialClientApplication.AcquireTokenOnBehalfOfAsync` проверит кэш MSAL, который находится в памяти, на наличие подходящего маркера доступа. Только в случае его отсутствия запускается поток "от имени" с конечной точкой Azure AD версии 2.
    * Если ресурс Microsoft Graph требует многофакторной проверки подлинности, а пользователь еще не предоставил соответствующие данные, AAD вызовет исключение, содержащее свойство Claims.
    * Значение свойства Claims необходимо передать клиенту, который передаст его ведущему приложению Office. Последнее добавит его в запрос на получение нового токена. AAD будет отображать для пользователя запрос на все необходимые проверки подлинности.
    * Любые исключения, отличные от типа `MsalUiRequiredException`, не перехватываются преднамеренно, поэтому будут переданы клиенту.

    ```
    AuthenticationResult result = null;
    try
    {
        result = await cca.AcquireTokenOnBehalfOfAsync(graphScopes, userAssertion, "https://login.microsoftonline.com/common/oauth2/v2.0");
    }
    catch (MsalUiRequiredException e)
    {        
        if (String.IsNullOrEmpty(e.Claims))
        {
            throw e;
        }
        else
        {
            throw new HttpException(e.Claims);
        }   
    }
    ```

8. Замените TODO8 приведенным ниже кодом. Примечание.

    * Классы `GraphApiHelper` и `ODataHelper` определяются в файлах из папки **Helpers**. Класс `OneDriveItem` определяется в файле из папки **Models**. В этой статье не представлено подробное описание этих классов, так как оно не имеет отношения к авторизации и единому входу.
    * Производительность будет выше, если запрашивать у Microsoft Graph только действительно необходимые данные, поэтому в коде заданы параметры ` $select` и `$top`. Первый из них (параметр запроса) показывает, что нужно только свойство name, второй — что требуются только первые 3 названия папок или файлов.

    ```
    var fullOneDriveItemsUrl = GraphApiHelper.GetOneDriveItemNamesUrl("?$select=name&$top=3");
    var getFilesResult = await ODataHelper.GetItems<OneDriveItem>(fullOneDriveItemsUrl, result.AccessToken);
    ```

9. Замените TODO9 приведенным ниже кодом. Обратите внимание: приведенный выше код запрашивает только свойство *name* элементов OneDrive, но Microsoft Graph всегда включает свойство *eTag* для элементов OneDrive. Чтобы сократить количество полезных данных, отправляемых клиенту, приведенный ниже код преобразует результаты, оставляя только имена элементов.

    ```
    List<string> itemNames = new List<string>();
    foreach (OneDriveItem item in getFilesResult)
    {
      itemNames.Add(item.Name);
    }                    
    return itemNames;
    ```

## <a name="run-the-add-in"></a>Запуск надстройки

1. Убедитесь в наличии нескольких файлов в OneDrive, чтобы можно было проверить результаты.

1. В Visual Studio нажмите клавишу F5. Откроется PowerPoint, где на ленте **Главная** появится группа **SSO ASP.NET**.

1. Нажмите кнопку **Показать надстройку** в этой группе. Отобразится пользовательский интерфейс надстройки в области задач.

1. Нажмите кнопку **Get My Files from OneDrive** (Получить мои файлы из OneDrive). Если вы не вошли в Office, вам будет предложено сделать это.
    > **Примечание.** Если вы ранее выполняли вход в Office с использованием другого идентификатора и все еще не закрыли некоторые из открытых тогда приложений Office, Office может не сменить идентификатор (даже если кажется, что это сделано для PowerPoint). Если это произойдет, возможен сбой при вызове Microsoft Graph или возврат данных для другого идентификатора. Чтобы избежать этого, *закройте все приложения Office*, прежде чем нажимать кнопку **Get My Files from OneDrive** (Получить мои файлы из OneDrive).

1. Когда выполните вход, под кнопкой отобразится список файлов и папок из OneDrive. Это может занять более 15 секунд, особенно в первый раз.
