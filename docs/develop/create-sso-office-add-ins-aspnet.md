---
title: ???????? ????? ?????????? Office ?? ????????? ASP.NET, ??? ??????? ???????????? ?????? ????
description: ''
ms.date: 01/23/2018
ms.openlocfilehash: 6a1c8ea7a8634d701a43e08fd8bb9c5f9c1863cd
ms.sourcegitcommit: c72c35e8389c47a795afbac1b2bcf98c8e216d82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/23/2018
---
# <a name="create-an-aspnet-office-add-in-that-uses-single-sign-on-preview"></a>???????? ?????????? Office, ? ??????? ???????????? ?????? ????, ?? ????????? ASP.NET (??????????????? ??????)

???? ?????????? ????? ????????????? ????????????? ?????? ? ?????????? ???????????, ????????? ??????? ??????, ????????? ??? ????? ? Office. [??? ???????? ?????? ???? ? ?????????? Office](sso-in-office-add-ins.md)

?? ???? ?????? ?? ???????, ??? ???????? ?????? ???? ? ??????????, ????????? ? ??????? ASP.NET, OWIN ? MSAL ??? .NET.

> [!NOTE]
> ???????? ? ???????? ??????????, ? ??????? ???????????? ?????? ????, ?? ?????? Node.js ??. ? [???? ??????](create-sso-office-add-ins-nodejs.md).

## <a name="prerequisites"></a>??????????? ??????????

* ????????? ????????? ?????? Visual Studio 2017 Preview.

* Office 2016 (?????? 1708, ?????? 8424.nnnn) ??? ????? ??????? (??? ?????? ???????? ?? Office 365 ?????? ???????? "????? ? ???????"). ????? ??????? ??? ??????, ??? ????? ????????????? ??????? ??????? ? ????????? ??????????????? ?????? Office. ?????????????? ???????? ??. ? ?????? [??????? ??????? ? ????????? ??????????????? ?????? Office](https://products.office.com/en-us/office-insider?tab=tab-1).

## <a name="set-up-the-starter-project"></a>????????? ?????????? ???????

1. ?????????? ??? ???????? ??????????? [Office Add-in ASPNET SSO](https://github.com/officedev/office-add-in-aspnet-sso).

1. ????????? ? ????? **Before** ? ???????? SLN-???? ? Visual Studio. ??? ????????? ??????. ???????????????? ????????? ? ?????? ??????? ??????????, ?? ????????? ??????????????? ? ?????? ?????? ? ????????????, ??? ??????.

    > [!NOTE]
    > ? ??? ?? ??????????? ???? ??????? ?????? ???????. ??? ????????? ??????????, ??????? ?? ?????????, ???????? ????????? ?? ???? ??????, ?? ??? ???????????, ??? ??????? ?????? ???????? ??????????? ? ????. ? ??? ??? ?????????????, ???? ?? ??????? ??? ??????. ????? ???????????? ??????? ??????, ?????? ???????? ???? `sln` ? ????????? ????????, ????????? ? ???? ??????, ????????? ??????? **??? ?? ??????? ???????** ? **??? ?? ??????? ???????**.

1. ?????? ??????, ????????? ??? ?????? ? Visual Studio. ??? ???? ????? ??????????? ??????, ????????? ? ????? packages.config. ??? ????? ?????? ?? ???? ?????? ?? ?????????? ????? ? ??????????? ?? ????, ??????? ??????? ???????? ? ????????? ???? ??????? ?? ??????????.

    > [!NOTE]
    > ?? ??????? ????????? ?? ??????, ?????????? ???????????? ???? Identity. ??? ???????? ?????? ???????? ? ?????????????, ??????? ?? ????????? ?? ????????? ?????. ????? ??, ??? ?????? ???????????????.

1. ? ????????? ?????? ?????? ?????????? MSAL (Microsoft.Identity.Client), ??????? ????? ??? ??????? ????? (?????? `1.1.1-alpha0393`), ?? ???????? ? ??????????? ??????? NuGet, ??????? ?? ??????? ? package.config. ?? ????? ?????????? ????????. 

   > 1. ? ???? **??????** ???????? **????????? ??????? NuGet** > **??????? ?????????? ???????**. 

   > 2. ? ??????? ????????? ????????? ???? ???????. ?????????? ????? ?????? ?????? ??? ?????? ???????, ???? ??? ??????? ??????????? ? ?????????. ????? ??? ????? ??????, ? ?????? ????? ???? ??????? ??????????? ????? ?????????: **"Microsoft.Identity.Client 1.1.1-alpha0393" ??????? ???????????...**.

   >    `Install-Package Microsoft.Identity.Client -Version 1.1.1-alpha0393 -Source https://www.myget.org/F/aad-clients-nightly/api/v3/index.json`

   > 3. ? **???????????? ???????** ???????? ?????? ??????? ???? ???? **References**. ?????????, ??? ?????? **Microsoft.Identity.Client** ???? ? ??????. ???? ?? ??? ??? ????? ? ??? ???????????? ?????? ??????????????, ??????? ??? ??????, ? ????? ? ??????? ??????? ?????????? ?????? Visual Studio ???????? ?????? ? ??????, ?????? **? \[Begin | Complete]\packages\Microsoft.Identity.Client.1.1.1-alpha0393\lib\net45\Microsoft.Identity.Client.dll**.

1. ??? ??? ????????? ?????? ???????.

## <a name="register-the-add-in-with-azure-ad-v20-endpoint"></a>??????????? ?????????? ? ???????? ????? Azure AD ?????? 2.0

????????? ?????????? ???????? ????? ??????????, ??????? ?? ????? ???????????? ? ?????????? ??????. ??? ???? ?????? ???????? ?????????:
- ???????? ??????????? **$ADD-IN-NAME$** ?? `Office-Add-in-ASPNET-SSO`.
- ???????? ??????????? **$FQDN-WITHOUT-PROTOCOL$** ?? `localhost:44355`.
- ??? ???????? ?????????? ? ?????????? ???? **??????? ??????????** ?????????? ?????? ??? ????????? ??????????. ??? ????? ?????????? ????????? ?????? ?????? ??????????, ?? ??? ?????????? MSAL, ? ??????? ???????????? ??? ?? ??????? ???????, ????????? `offline_access` ? `openid`. ?????????? `profile` ??????????, ????? ??????? ?????????? Office ???????? ????? ??? ???-?????????? ??????????.
    * Files.Read.All
    * offline_access
    * openid
    * ???????


[!INCLUDE[](../includes/register-sso-add-in-aad-v2-include.md)]

## <a name="grant-administrator-consent-to-the-add-in"></a>?????????????? ?????????? ???????? ??????????????

[!INCLUDE[](../includes/grant-admin-consent-to-an-add-in-include.md)]

## <a name="configure-the-add-in"></a>???????????? ??????????

1. ? ????????? ?????? ???????? ??????????? "{tenant_ID}" ?? ????????????? ??????? Office 365. ??? ??? ????????? ??????????? ???? ?? ???????, ????????? ? ?????? [??? ????? ???? ????????????? ??????? Office 365](https://support.office.com/en-us/article/Find-your-Office-365-tenant-ID-6891b561-a52d-4ade-9f39-b492285e2c9b).

    `https://login.microsoftonline.com/{tenant_ID}/v2.0`

2. ???????? ???? web.config ? Visual Studio. ? ??????? **appSettings** ???? ?????, ??????? ?????????? ????????? ????????.

3. ??????????? ??????, ???????????? ?? ???? 1, ? ???????? ???????? ????? ida:Issuer. ?????????, ??? ? ???????? ??? ????????.

4. ??????? ????????? ???? ???????? ??? ??????????????? ??????.

    |????|????????|
    |:-----|:-----|
    |ida:ClientID|????????????? ??????????, ?????????? ?? ????? ??????????? ??????????.|
    |ida:Audience|????????????? ??????????, ?????????? ?? ????? ??????????? ??????????.|
    |ida:Password|??????, ??????? ?? ???????? ?? ????? ??????????? ??????????.|

   ???? ??????? ?????? ????, ??? ?????? ????????? ?????? ?????????? ???? ?????. *???????? ????????, ??? ????????? ClientID ? Audience ????? ?????????? ????????*. ?? ????? ?????? ???????????? ???? ???? ??? ????? ?????, ?? ???? ???????? web.config ????? ????? ???????? ????????????, ???? ?? ????????? ??, ??? ??? ??? ?? ?????? ????? ???????????. ????? ????, ??????? ????????? ?????? ????????? ??????? ???? ?????????? ? ???????? OAuth, ????????? ? ??????? ??????????? Office, ? ???????? OAuth, ????????? ? Microsoft Graph.

    ```xml
    <add key=”ida:ClientID" value="12345678-1234-1234-1234-123456789012" />
    <add key="ida:Audience" value="12345678-1234-1234-1234-123456789012" />
    <add key="ida:Password" value="rFfv17ezsoGw5XUc0CDBHiU" />
    <add key="ida:Issuer" value="https://login.microsoftonline.com/aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee/v2.0" />
    
    ```

   > [!NOTE]
   > ???????? ????????? ????????? ? ??????? **appSettings** ??? ?????????.

1. ????????? ? ???????? ????.

1. ? ??????? ?????????? ???????? ???? ????????? Office-Add-in-ASPNET-SSO.xml.

1. ????????? ? ????? ???? ?????.

1. ??? ??????????? ????? `</VersionOverrides>` ?? ??????? ????????? ????? ????:

    ```xml
    <WebApplicationInfo>
      <Id>{application_GUID here}</Id>
      <Resource>api://localhost:44355/{application_GUID here}</Resource>
      <Scopes>
          <Scope>Files.Read.All</Scope>
          <Scope>offline_access</Scope>
          <Scope>openid</Scope>
          <Scope>profile</Scope>
      </Scopes>
    </WebApplicationInfo>
    ```

1. ???????? ??????????? {application_GUID here} *? ????? ??????* ???? ??????????????? ??????????, ????????????? ?? ????? ??????????? ??????????. "{}" ?? ???????? ?????? ??????????????, ??????? ?? ????????? ??. ??? ??? ?? ?????????????, ??????? ????????????? ??? ClientID ? Audience ? ????? web.config.

    > [!NOTE]
    > * ???????? **Resource** ???????????? ????? **URI ?????????????? ??????????**, ??????? ?? ??????, ????? ????????? ????????? ???-API ??? ??????????? ??????????.
    > * ?????? **Scopes** ???????????? ??? ???????? ??????????? ???? ?????????????? ??????????, ?????? ???? ?????????? ????????? ? AppSource.

1. ???????? ??????? **??????????????** ? **?????? ??????** ? Visual Studio. ?????????????? ? ???, ??? `<WebApplicationInfo>` ?? ???????? ?????????????? ???????? ????? `<VersionOverrides>`, ????????, ??? ???????????? ???? ?????? Visual Studio 2017 Preview ?? ????? ?????????? ???????? ??????? ?????. ? ???????? ????????? ??????? ? ?????????? Word, Excel ??? PowerPoint ????? ????????? ????????? ???? ????????. ???? ?? ????????? ? ??????????? Outlook, ?? ??????? ??????? ????.

   - **???????? ??????? ??? Word, Excel ? Powerpoint**

        1. ??????????????? ?????? `<WebApplicationInfo>` ? ????????? ????? ????? ??????????? ???? `</VersionOverrides>`.

        2. ??????? ??????? F5, ????? ????????? ????? ???????. ? ?????????? ????? ??????? ????? ????????? ? ????????? ????? (?????? ? ??????? ????? ???????? ? **??????????**, ??? ? Visual Studio): `Office-Add-in-ASP.NET-SSO\Complete\Office-Add-in-ASPNET-SSO\bin\Debug\OfficeAppManifests`

        3. ? ????? ????????? ??????? ????????? ??????????? ??? ??????? `<WebApplicationInfo>`.

        4. ????????? ????? ?????????.

        5. ?????? ?????????? ??????? ????, ????? Visual Studio ?? ??????????? ????? ?????????, ????? ?? ? ????????? ??? ??????? ??????? F5. ???????? ?????? ??????? ???? ???? ??????? ? ??????? ????? **???????????? ???????** (?? ?? ???? ????????).

        6. ? ??????????? ???? ???????? **????????**. ????????? ?????????? ???? **???????? ??????? ???????**.

        7. ?????????? ????? **???????? ????????????** ? ???????? **????????????**.

        8. ??????? ?????? **????????? ??????** ? **??????????** ? ?????? ??? ??????? **Office-Add-in-ASPNET-SSO** (?? *??* ??????? **Office-Add-in-ASPNET-SSO-WebAPI**).

        9. ???????? ?????????? ????, ????? ?????? **??**.

   - **???????? ??????? ??? Outlook**

        1. ??????? ???? `MailAppVersionOverridesV1_1.xsd` ?? ??????????, ???????????? ??? ??????????. ?? ?????? ?????????? ? ??? ????????, ? ??????? ??????????? ????? Visual Studio, ? ????? `./Xml/Schemas/{lcid}`. ????????, ??? ??????? ????????? 32-????????? ?????? VS 2017 ? ???????, ??? ???????????? ?????????? ???? (???), ?????? ???? ????? ????????? ???: `C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\Xml\Schemas\1033`.

        2. ???????? ??? ????????????? ????? ?? `MailAppVersionOverridesV1_1.old`.

        3. ?????????? ?????????? ?????? ????? ? ?????: [?????????? ????? MailAppVersionOverrides](https://github.com/OfficeDev/outlook-add-in-attachments-demo/blob/sso-conversion/manifest-schema-fix/MailAppVersionOverridesV1_1.xsd)

1. ????????? ? ???????? ??????? ???? ????????? ? Visual Studio.

## <a name="code-the-client-side"></a>??? ?? ??????? ???????

1. ???????? ???? Home.js ? ????? **Scripts**. ? ??? ??? ???? ????????? ???:
    * ?????????? ?????? `Office.initialize`, ???????, ? ???? ???????, ????????? ?????????? ??????? ??? ??????? ?????? `getGraphAccessTokenButton`.
    * ????? `showResult` ??? ??????????? ????????? ?? ?????? (??? ??????, ???????????? ?? Microsoft Graph) ? ?????? ????? ??????? ?????.
    * ????? `logErrors` ??? ??????????? ? ??????? ??????, ??????? ?? ????????????? ??? ????????????.

1. ????? ?????????? ??? ?????? `Office.initialize` ???????? ??????????? ???? ???. ??? ??? ????? ????? ?? ???? ????:

    * ??? ????????? ?????? ? ?????????? ?????? ????????????? ??????????? ??? ???? ??????? ???????? ?????? ??????? ? ??????? ??????? ?????? ??????????. ?????????? ???????? `timesGetOneDriveFilesHasRun` ? ?????????? ?????? `triedWithoutForceConsent` ????????????, ????? ????????????? ??????????? ?????????? ????????? ??????? ???????? ??????. 
    * ????? `getDataWithToken` ????????? ?? ????????? ????. ???????? ???????? ?? ??, ??? ?? ??????????? ????????? `forceConsent` ???????? `false`. ?????????????? ???????? ??. ? ???????? ?????????? ????.

    ```javascript
    var timesGetOneDriveFilesHasRun = 0;
    var triedWithoutForceConsent = false;

    function getOneDriveFiles() {
        timesGetOneDriveFilesHasRun++;
        triedWithoutForceConsent = true;
        getDataWithToken({ forceConsent: false });
    }   
    ```

1. ??? ??????? `getOneDriveFiles` ???????? ??????????? ???? ???. ??? ??? ????? ????? ?? ???? ????:

    * ? ??? ????? API ? Office.js, ??????????? ?????????? ??????????? ? ???????? ?????????? Office (Excel, PowerPoint, Word ? ?. ?.) ?????? ??????? ? ?????????? ??? ????????????, ????????? ? Office. ??????? ?????????? Office ??????????? ?????? ? ???????? ????? Azure AD 2.0. ??? ??? ?? ?????????????? ???????????? ??????? ?????????? Office ??? ?????????? ?? ????? ?? ???????????, Azure AD ???????? ??????.`getAccessTokenAsync`
    * ???? ???? ? Office ?? ????????, ??????? ?????????? Office ????????? ???????????? ?????.
    * ???????? ???????? ?????? ??? `forceConsent` ???????? `false`, ??????? ???????????? ?? ????? ???????????? ????????? ???????? ?????????? Office ?????? ? ?????????? ??? ?????? ?? ?????????????. ??? ?????? ??????? ?????????? ????? `getAccessTokenAsync` ?? ????? ????????, ?? ?????? ????????? ??????, ??????? ?? ???????? ?? ????????? ?????, ????????????? ???????? ????????? ?????, ??? ???? ????????? `forceConsent` ????? ?????? ???????? `true`, ? ???????????? ????? ?????????? ???????????. ????? ????????? ??????????? ?????? ? ?????? ???.
    * ?? ????????? ????? `handleClientSideErrors` ?????.

    ```javascript
    function getDataWithToken(options) {
    Office.context.auth.getAccessTokenAsync(options,
        function (result) {
            if (result.status === "succeeded") {
                TODO1: Use the access token to get Microsoft Graph data.
            }
            else {
                handleClientSideErrors(result);
            }
        });
    }
    ```

1. ???????? ?????? TODO1 ?? ??????????? ???? ??????. ????? `getData` ? ????????? ??????? /api/values ????????? ?????. ??? ???????? ????? ???????????? ????????????? URL-?????, ??? ??? ??? ?????? ??????????? ?? ??? ?? ??????, ??? ? ??????????.

    ```javascript
    accessToken = result.value;
    getData("/api/values", accessToken);
    ```

1. ??? ??????? `getOneDriveFiles` ???????? ??????????? ???? ???. ??? ??? ????? ????? ?? ???? ????:

    * ???? ????? ???????? ????????? ???????? ????? ???-API ? ???????? ?? ??? ?? ?????? ???????, ??????? ??????? ?????????? Office ???????????? ??? ??????? ? ??????????. ?? ??????? ??????? ???? ?????? ??????? ????? ?????????????? ? ?????? "?? ?????" ??? ????????? ??????? ??????? ? Microsoft Graph.
    * ?? ????????? ????? `handleServerSideErrors` ?????.

    ```javascript
    function getData(relativeUrl, accessToken) {
        $.ajax({
            url: relativeUrl,
            headers: { "Authorization": "Bearer " + accessToken },
            type: "GET"
        })
        .done(function (result) {
            showResult(result);
        })
        .fail(function (result) {
            handleServerSideErrors(result);
        }); 
    }
    ```

### <a name="create-the-error-handling-methods"></a>???????? ??????? ????????? ??????

1. ??? ??????? `getData` ???????? ??????????? ???? ?????. ???? ????? ????? ???????????? ?????? ? ??????? ??????????, ????? ??????? ?????????? Office ?? ?????? ???????? ?????? ??????? ? ???-?????? ??????????. ????????? ? ????? ??????? ???????? ??? ??????, ??????? ?????? ????? ????????? ?? ? ??????? ????????? `switch`.

    ```javascript
    function handleClientSideErrors(result) {

        switch (result.error.code) {
    
            // TODO2: Handle the case where user is not logged in, or the user cancelled, without responding, a
            //        prompt to provide a 2nd authentication factor. 
    
            // TODO3: Handle the case where the user's sign-in or consent was aborted.
    
            // TODO4: Handle the case where the user is logged in with an account that is neither work or school, 
            //        nor Micrososoft Account.
    
            // TODO5: Handle an unspecified error from the Office host.
    
            // TODO6: Handle the case where the Office host cannot get an access token to the add-ins 
            //        web service/application.
    
            // TODO7: Handle the case where the user tiggered an operation that calls `getAccessTokenAsync` 
            //        before a previous call of it completed.
    
            // TODO8: Handle the case where the add-in does not support forcing consent.
    
            // TODO9: Log all other client errors.
        }
    }
    ```

1. ???????? `TODO2` ??????????? ???? ?????. ?????? 13001 ?????????, ???? ???????????? ?? ???????? ???? ??? ??? ??????? ??????? ?????? ?? ?????????????? 2-?? ??????? ???????? ???????????. ? ????? ??????? ??? ???????? ????????? ????? `getDataWithToken` ? ?????? ???????? ??? ??????????????? ???????????? ?????.

    ```javascript
    case 13001:
        getDataWithToken({ forceAddAccount: true });
        break;
    ```

1. ???????? `TODO3` ??????????? ???? ?????. ?????? 13002 ?????????, ????? ???? ??? ?????????????? ?????????? ???????????. ????????? ???????????? ????????? ???????, ?? ?? ????? ?????? ????.

    ```javascript
    case 13002:
        if (timesGetOneDriveFilesHasRun < 2) {
            showResult(['Your sign-in or consent was aborted before completion. Please try that operation again.']);
        } else {
            logError(result);
        }          
        break; 
    ```

1. ???????? `TODO4` ??????????? ???? ?????. ?????? 13003 ?????????, ????? ???????????? ?????? ??? ??????? ???????, ???????? ?? ???????, ??????? ??? ?????? ??????? ?????? ??????????. ????????? ???????????? ?????, ? ????? ????? ? ??????? ??????? ?????? ??????????????? ????.

    ```javascript
    case 13003: 
        showResult(['Please sign out of Office and sign in again with a work or school account, or Microsoft Account. Other kinds of accounts, like corporate domain accounts do not work.']);
        break;   
    ```

    > [!NOTE]
    > ?????? 13004 ? 13005 ?? ?????????????? ??? ????????????? ????? ??????, ??? ??? ??? ?????? ????????? ?????? ?? ?????? ??????????. ?? ?????????? ????????? ? ??????? ???? ????? ??????????, ??????? ??? ?????? ???????? ? ??? ????????????.

1. ???????? `TODO5` ??????????? ???? ?????. ?????? 13006 ?????????, ???? ?????????? ?????????????? ?????? ???????? ?????????? Office, ??????? ????? ????????????????? ? ??? ???????????? ?????????. ????????? ???????????? ????????????? Office.

    ```javascript
    case 13006:
        showResult(['Please save your work, sign out of Office, close all Office applications, and restart this Office application.']);
        break;        
    ```

1. ???????? `TODO6` ??????????? ???? ?????. ?????? 13007 ?????????, ????? ?????????? ?????????????? ???????? ?????????? Office ? AAD, ??-?? ???? ??? ?????????? ?? ????? ???????? ?????? ??????? ? ???-??????/?????????? ??????????. ??? ????? ???? ??-?? ?????????? ???? ????. ????????? ???????????? ????????? ??????? ?????.

    ```javascript
    case 13007:
        showResult(['That operation cannot be done at this time. Please try again later.']);
        break;      
    ```

1. ???????? `TODO7` ??????????? ???? ?????. ?????? 13008 ?????????, ????? ???????????? ????????? ????????, ??????? ???????? `getAccessTokenAsync`, ?? ?????????? ??????????? ??????.

    ```javascript
    case 13008:
        showResult(['Please try that operation again after the current operation has finished.']);
        break;
    ```      

1. ???????? `TODO8` ????????? ???? ?????. ?????? 13009 ?????????, ???? ?????????? ?? ???????????? ?????????????? ???????????? ??????????, ?? ??????????? ????? `getAccessTokenAsync` ? ?????????? ??? ????????? `forceConsent` ???????? `true`. ?????? ? ????? ?????? ??? ?????? ????????????? ???????? ????????? ????? `getAccessTokenAsync` ? ??????????, ??????? ???????? `false`. ?? ? ????????? ??????? ????? ?????? ? ?????????? ??? ????????? `forceConsent` ???????? `true` ??? ?? ???? ???????? ?????????????? ???????? ?? ?????? ?????? ?????? ? ?????????? ??? ????????? ???????? `false`. ? ???? ?????? ??? ?????? ?? ????????? ???????, ? ?????????? ???????????? ????? ? ????? ??????.

    ```javascript
    case 13009:
        if (triedWithoutForceConsent) {
            showResult(['Please sign out of Office and sign in again with a work or school account, or Microsoft Account.']);
        } else {
            getDataWithToken({ forceConsent: false });
        }
        break;
    ```      
    
1. ???????? `TODO9` ??????????? ???? ?????.

    ```javascript
    default:
        logError(result);
        break;
    ```  


1. ??? ??????? `handleClientSideErrors` ???????? ??????????? ???? ?????. ???? ????? ???????????? ?????? ? ???-?????? ?????????? ??? ???????????? ?????????? ?????? "?? ?????" ??? ????????? ?????? ?? Microsoft Graph.

    ```javascript
    function handleServerSideErrors(result) {
    
        // TODO10: Parse the JSON response.

        // TODO11: Handle the case where AAD asks for an additional form of authentication.

        // TODO12: Handle the case where consent has not been granted, or has been revoked.

        // TODO13: Handle the case where an invalid scope (permission) was used in the on-behalf-of flow.

        // TODO14: Handle the case where the token that the add-in's client-side sends to it's 
        //         server-side is not valid because it is missing `access_as_user` scope (permission).

        // TODO15: Handle the case where the token sent to Microsoft Graph in the request for 
        //         data is expired or invalid.

        // TODO16: Log all other server errors.
    }
    ```

1. ???????? `TODO10` ????????? ???? ?????. ???????? ????????, ??? ??? ??????????? ?????? `4xx`, ??????? ???-?????? ????? ?????????? ?????????? ????? ??????????, ? ?????? ????? ???????? **ExceptionMessage**, ?????????? ????? ?????? AADSTS ? ?????? ??????. ??????, ????? AAD ?????????? ???-?????? ?????????? ?????? ?????????????? ???????? ???????????, ???? ?????? ???????? ??????????? ???????? **Claims** ? ????? ??????????? ?????????????? ????????. API ASP.NET, ??????? ??????? ? ?????????? HTTP-?????? ????????, ?? ????? ?? ???? ???????? **Claims**, ??????? ?? ???????? ??? ? ?????. ????????? ???, ??????? ?? ????????? ?????, ????? ??????? ????????? ???????? **Claims** ? ?????, ????? ?????? ??? ????????. ??? ???????? ????? ?????????? ? ???????? **Message**, ??????? ??? ????? ?????? ????????????? ??? ????????.

    ```javascript
    var exceptionMessage = JSON.parse(result.responseText).ExceptionMessage;
    var message = JSON.parse(result.responseText).Message;
    ```

1. ???????? `TODO11` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ?????? 50076 ?????????, ????? Microsoft Graph ??????? ?????????????? ???????? ???????????.
    * ???????? ?????????? Office ?????? ???????? ????? ?????? ?? ????????? **Claims** ? ???????? ????????? `authChallenge`. ? ?????????? AAD ????????? ???????????? ?????? ??? ??????????? ???????? ???????????. 

    ```javascript
    if (message) {
        if (message.indexOf("AADSTS50076") !== -1) {
            var claims = JSON.parse(message).Claims;
            var claimsAsString = JSON.stringify(claims);
            getDataWithToken({ authChallenge: claimsAsString });
        }
    }    
    ```

1. ???????? `TODO12` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ?????? 65001 ????????, ??? ?????? ? Microsoft Graph ?? ??? ???????????? (??? ??? ???????) ??? ?????? ??? ?????????? ??????????. 
    * ?????????? ?????? ???????? ????? ?????? ? ?????????? `forceConsent`, ??????? ???????? `true`.

    ```javascript
    if (exceptionMessage.indexOf('AADSTS65001') !== -1) {
        showResult(['Please grant consent to this add-in to access your Microsoft Graph data.']);        
        /*
            THE FORCE CONSENT OPTION IS NOT AVAILABLE IN DURING PREVIEW. WHEN SSO FOR
            OFFICE ADD-INS IS RELEASED, REMOVE THE showResult LINE ABOVE AND UNCOMMENT
            THE FOLLOWING LINE.
        */
       // getDataWithToken({ forceConsent: true });
    }    
    ```

1. ???????? `TODO13` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ?????? 70011 ????? ????????? ????????. ??????? ??? ???? ?????????? ? ???????????? ????????????? ??????????, ??????? ??? ????????? ??????? ??????? ???????? ??????, ? ?? ?????? ??????.
    * ?????????? ?????? ???????? ?? ??????.

    ```javascript
     else if (exceptionMessage.indexOf("AADSTS70011: The provided value for the input parameter 'scope' is not valid.") !== -1) {
        showResult(['The add-in is asking for a type of permission that is not recognized.']);
    }    
    ```

1. ???????? `TODO14` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ????????? ???, ??????? ?? ????????? ?????, ???????? ????????? `Missing access_as_user`, ???? ?????????? `access_as_user` ?? ????? ? ??????? ???????, ??????? ?????? ?????????? ???????? ? AAD ??? ????????????? ? ?????? "?? ?????".
    * ?????????? ?????? ???????? ?? ??????.

    ```javascript
    else if (exceptionMessage.indexOf('Missing access_as_user.') !== -1) {
        showResult(['Microsoft Office does not have permission to get Microsoft Graph data on behalf of the current user.']);
    }    
    ```

1. ???????? `TODO15` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ?????????? ?????????????, ??????? ?? ?????? ???????????? ? ????????? ???? (MSAL), ?????? ????????????? ???????? ? Microsoft Graph ?????????? ? ???????????????? ????????. ?? ???? ??? ???-???? ??????????, Microsoft Graph ?????? ???-?????? ?????????? ?????? ? ????? `InvalidAuthenticationToken`. ????????? ???, ??????? ?? ????????? ?????, ???????? ??? ????????? ??????? ??????????.
    * ? ???? ?????? ?????????? ?????? ?????? ???? ??????? ???????? ??????????? ????? ?????? ?????????? ???????? ? ??????, ? ????? ???????? ??????? ????? ??????????? ??????.

    ```javascript
    // If the token sent to MS Graph is expired or invalid, start the whole process over.
    else if (result.code === 'InvalidAuthenticationToken') {
        timesGetOneDriveFilesHasRun = 0;
        triedWithoutForceConsent = false;
        getOneDriveFiles();
    }    
    ```

1. ???????? `TODO16` ??????????? ???? ?????.

    ```javascript
    else {
        logError(result);
    }    
    ```

1. ????????? ? ???????? ????.

## <a name="code-the-server-side"></a>??? ?? ??????? ???????

### <a name="configure-the-owin-middleware"></a>????????? ?? ?????????????? ???? OWIN

1. ???????? ???? Startup.cs ? ???????? ????? ???????.

1. ???????? ???????? ????? `partial` ? ?????????? ?????? Startup, ???? ??? ??? ??? ???. ??? ?????? ????????? ???:

    `public partial class Startup`

1. ???????? ??????????? ???? ?????? ? ????? ?????? `Configuration`. ????? `ConfigureAuth` ????????? ?????.

    `ConfigureAuth(app);`

1. ????????? ? ???????? ????.

1. ???????? ?????? ??????? ???? ????? **App_Start** ? ???????? **???????? > ?????**.

1. ? ?????????? ???? **???????? ????? ???????** ??????? ??? ????? **Startup.Auth.cs** ? ??????? ?????? **????????**.

1. ????????? ??? ???????????? ???? ? ????? ????? ?? `Office_Add_in_ASPNET_SSO_WebAPI`.

1. ?????????, ??? ? ?????? ????? ???? ??? ??????????? ???? ????????? `using`.

    ```csharp
    using Owin;
    using System.IdentityModel.Tokens;
    using System.Configuration;
    using Microsoft.Owin.Security.OAuth;
    using Microsoft.Owin.Security.Jwt;
    using Office_Add_in_ASPNET_SSO_WebAPI.App_Start;
    ```

1. ???????? ???????? ????? `partial` ? ?????????? ?????? `Startup`, ???? ??? ??? ??? ???. ??? ?????? ????????? ???:

    `public partial class Startup`

1. ???????? ??????????? ???? ????? ? ????? `Startup`. ???? ????? ?????????, ??? ?? ?????????????? ???? OWIN ????? ????????? ??????? ???????, ???????????? ??? ?? ?????? `getData` ? ????? Home.js ?? ??????? ???????. ??????? ?????????? ??? ?????? ?????? ???????? ????? ???-API, ?????????? ??????? `[Authorize]`.

    ```csharp
    public void ConfigureAuth(IAppBuilder app)
    {
        // TODO3: Configure the validation settings
        // TODO4: Specify the type of authorization and the discovery endpoint
        // of the secure token service.
    }
    ```

1. ???????? TODO3 ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ??? ???????? OWIN ? ????????????? ?????????, ??? ????????? ? ????????? ???????, ????????? ? ??????? ??????? ?? ???????? ?????????? Office (??????? ?????????? ????? ?????? ?????? `getData` ?? ??????? ???????), ?????? ????????? ?? ??????????, ?????????? ? ????? web.config.
    * ???? ?????? ??? ???????? `SaveSigninToken` ???????? `true`, OWIN ???????? ?????????????? ?????? ?? ???????? ?????????? Office. ?? ????????? ??????????, ????? ???????? ?????? ??????? ? Microsoft Graph ? ?????? "?? ?????".
    * ?? ?????????????? ???? OWIN ?? ????????? ??????????. ?????????? ??????? ???????, ??????? ?????? ???????? `access_as_user`, ??????????? ? ???????????.

    ```csharp
    var tvps = new TokenValidationParameters
        {
            ValidAudience = ConfigurationManager.AppSettings["ida:Audience"],
            ValidIssuer = ConfigurationManager.AppSettings["ida:Issuer"],
            SaveSigninToken = true
        };
    ```

1. ???????? TODO4 ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ????? `UseOAuthBearerAuthentication` ?????????? ?????? ????? ????????????????? ?????? `UseWindowsAzureActiveDirectoryBearerAuthentication`, ??? ??? ????????? ??????????? ? ???????? ?????? Azure AD ?????? 2.
    * ?? ?????????????? ???? OWIN ?????????? URL-????? ???????????, ???????????? ??????, ????? ???????? ????, ??????????? ??? ???????? ??????? ? ??????? ???????, ?????????? ?? ???????? ?????????? Office.

    ```csharp
    app.UseOAuthBearerAuthentication(new OAuthBearerAuthenticationOptions
        {
            AccessTokenFormat = new JwtFormat(tvps, new OpenIdConnectCachingSecurityTokenProvider("https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration"))
        });
    ```

1. ????????? ? ???????? ????.

### <a name="create-the-apivalues-controller"></a>???????? ??????????? /api/values

1. ???????? ???? **Controllers\ValueController.cs**.

2. ?????????, ??? ? ?????? ????? ???? ??????????? ???? ?????????? ? `using`.

    ```csharp
    using Microsoft.Identity.Client;
    using System.IdentityModel.Tokens;
    using System.Collections.Generic;
    using System.Configuration;
    using System.Linq;
    using System.Security.Claims;
    using System.Threading.Tasks;
    using System.Web.Http;
    using System;
    using System.Net;
    using System.Net.Http;
    using Office_Add_in_ASPNET_SSO_WebAPI.Helpers;
    using Office_Add_in_ASPNET_SSO_WebAPI.Models;
    ```

3. ??? ??????? ? ??????????? `ValuesController` ???????? ??????? `[Authorize]`. ??? ???????????, ??? ?????????? ????? ????????? ??????? ???????????, ??????????? ? ????????? ?????????, ??? ?????? ?????? ?????? ???????????. ???????? ?????? ??????????? ????? ?????? ??? ??????? ??????????????? ??????? ??????? ? ??????????.

    > [!NOTE]
    > ???????????????? ?????? ???-API ?? ?????? ASP.NET MVC ?????? ????? ??????????? ?????? ??? ?????? "?? ?????" ? ????? ??? ?????????? ???????????????? ??????? [FilterAttribute](https://msdn.microsoft.com/en-us/library/system.web.http.filters(v=vs.108).aspx). ? ???? ??????? ?????? ?????????? ? ??????? ??????????, ????? ????? ???? ????? ?????????? ???? ????? ??????????? ? ?????? ????????? ??????. ????? ?? ?????? ???????????? ? ???????? ??????????? ? ??????? [Azure Samples](https://github.com/Azure-Samples/).    

4. ???????? ??????????? ???? ????? ? `ValuesController`. ???????? ????????, ??? ???????????? ???????? ? `Task<HttpResponseMessage>`, ? ?? `Task<IEnumerable<string>>`, ??????? ???? ???????????? ??? ?????? `GET api/values`. ??? ???????? ?????? ?????????? ???????????????? ?????? ??????????? ? ???????????: ??? ????????????? ????????? ?????? ???-?????? ?????? ?????????? HTTP-????? ??????? ??????????. 

    ```csharp
    // GET api/values
    public async Task<HttpResponseMessage> Get()
    {
        // TODO1: Validate the scopes of the access token.
    }
    ```

5. ???????? `TODO1` ??????????? ???? ?????, ????? ?????????, ??? ? ?????? ??????? ?????????? `access_as_user`.

    ```csharp
    string[] addinScopes = ClaimsPrincipal.Current.FindFirst("http://schemas.microsoft.com/identity/claims/scope").Value.Split(' ');
    if (addinScopes.Contains("access_as_user"))
    {
        // TODO2: Assemble all the information that is needed to get a token for Microsoft Graph using the "on behalf of" flow.
        // TODO3: Get the access token for Microsoft Graph.
        // TODO4: Get the names of files and folders in OneDrive by using the Microsoft Graph API.
        // TODO5: Remove excess information from the data and send the data to the client.
    }
    return SendErrorToClient(HttpStatusCode.Unauthorized, null, "Missing access_as_user.");
    ```

    > [!NOTE]
    > ??? ??????????? API, ??????? ???????? ?? ????? ?????????? ?? ????? ??????? ????????, ? ?????? ????????? Office ??????????? ?????? ??????? `access_as_user`. ??? ?????? API ? ?????? ?????? ???? ????????????? ????????? ??????????, ?????????? ????????. ??? ???????????? ???????, ? ??????? ????? ???????? ?????? ? ??????? ????????, ?????????? ??????? ?????????? Office.

6. ???????? `TODO2` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:
    * ??? ??????????? ?????????????? ?????? ???????, ?????????? ?? ???????? ?????????? Office, ? ?????? `UserAssertion`, ??????? ????? ??????? ??????? ??????.
    * ?????????? ?????? ?? ????????? ? ???? ??????? (??? ?????????), ?????? ? ???????? ????????? ???????? ?????????? Office ? ????????????. ?????? ??? ???? ???????? ????????, ???????? ????????? ?????? ? Microsoft Graph. `ConfidentialClientApplication` ? ??? ?????? "????????? ???????" MSAL.
    * ?????? ???????? ???????????? `ConfidentialClientApplication` ? URL-????? ???????????????. ?? ????? ???? ?? ?? ???????????? ? ?????? "?? ?????", ?? ??? ????? ????????????? ????????? ?????????? URL-?????. ? ??????? ?????????? ? ?????? ?????????? ????? ?????????? ?????????? ?????????, ??????? ????????? ???????? ???????????? ?????????????? ??????? ? ?????? ??????? ? ???????????. ? ???? ??????? ?? ??????????? ?????????? ?????????.
    * ??? ?????? ?????????? MSAL ????????? ??????? `openid` ? `offline_access`, ?? ???? ??? ?? ????????? ???????????, ????????? ??????. ????? ????, ?????? ?????????, ???? ??? ???????? `profile` (?????????? ???????????? ?????? ??? ????????? ??????? ??????????? Office ?????? ??? ???-?????????? ??????????). ??????? ????? ??????? ????????????? ?????? `Files.Read.All`.

    ```csharp
    var bootstrapContext = ClaimsPrincipal.Current.Identities.First().BootstrapContext as BootstrapContext;
    UserAssertion userAssertion = new UserAssertion(bootstrapContext.Token);
    ClientCredential clientCred = new ClientCredential(ConfigurationManager.AppSettings["ida:Password"]);
    ConfidentialClientApplication cca =
                    new ConfidentialClientApplication(ConfigurationManager.AppSettings["ida:ClientID"],
                                                      "https://localhost:44355", clientCred, null, null);
    string[] graphScopes = { "Files.Read.All" };
    ```

7. ???????? `TODO3` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ??? ?????? ????? `ConfidentialClientApplication.AcquireTokenOnBehalfOfAsync` ???????? ??? MSAL, ??????? ????????? ? ??????, ?? ??????? ??????????? ??????? ???????. ?????? ? ?????? ??? ?????????? ??????????? ????? "?? ?????" ? ???????? ?????? Azure AD ?????? 2.
    * ???? ?????? Microsoft Graph ??????? ?????????????? ???????? ???????????, ? ???????????? ??? ?? ??????????? ??????????????? ??????, AAD ??????? ??????????, ?????????? ???????? Claims.
    * ???????? ???????? Claims ?????????? ???????? ???????, ??????? ???????? ??? ???????? ?????????? Office. ????????? ??????? ??? ? ?????? ?? ????????? ?????? ??????. AAD ????????? ???????????? ?????? ??? ??????????? ???????? ???????????.
    * ????? ??????????, ???????? ?? ???? `MsalServiceException`, ?? ??????????????? ?????????????, ??????? ????? ???????? ??????? ? ???? ????????? `500 Server Error`.

    ```csharp
    AuthenticationResult result = null;
    try
    {
        result = await cca.AcquireTokenOnBehalfOfAsync(graphScopes, userAssertion, "https://login.microsoftonline.com/common/oauth2/v2.0");
    }
    catch (MsalServiceException e)
    {        
        // TODO3a: Handle request for multi-factor authentication.
        // TODO3b: Handle lack of consent.
        // TODO3c: Handle invalid scope (permission).
        // TODO3d: Handle all other MsalServiceExceptions.
    }
    ```

8. ???????? `TODO3a` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ???? ?????? Microsoft Graph ??????? ?????????????? ???????? ???????????, ? ???????????? ??? ?? ??????????? ??????????????? ??????, AAD ?????? ????????? "400 Bad Request" ? ??????? AADSTS50076 ? ???????? **Claims**. MSAL ?????? ?????????? **MsalUiRequiredException** (??????????? ?? ?????????? **MsalServiceException**) ? ???? ???????????. 
    * ???????? ???????? **Claims** ?????????? ???????? ???????, ??????? ???????? ??? ???????? ?????????? Office. ????????? ??????? ??? ? ?????? ?? ????????? ?????? ??????. AAD ????????? ???????????? ?????? ??? ??????????? ???????? ???????????.
    * API, ??????? ??????? HTTP-?????? ?? ??????????, ?? ????? ? ???????? **Claims**, ??????? ?? ???????? ??? ? ?????. ??? ????? ??????? ????????? ? ??? ???????. ?????? ????????????? ???????? **Message** ????????? ???????? ???????? **ExceptionMessage**, ??????? ???????????? ?????? ???????? ????????????? ?????? `AADSTS50076` ??????? ? ???????? ??? ? ????????????? ???????? **Message**. ??? JavaScript ? ??????? ?????? ????? ??????????, ????? ???????? ?????????? ? ?????? (**Message** ??? **ExceptionMessage**).
    * ????????? ????????? ? ??????? JSON, ????? ?????????? ??? JavaScript ??? ???????????????? ??? ? ??????? ????????? ??????? ??????? `JSON`.
    * ?? ????????? ????? `SendErrorToClient` ?????. ??? ?????? ???????? ? ?????? **Exception**. ? ???? ?????? ??? ???????? `null`, ?????? ??? ????????? ??????? **Exception** ????????? ????????? ???????? **Message** ? ??????????? HTTP-?????.

    ```csharp
    if (e.Message.StartsWith("AADSTS50076")) {
        string responseMessage = String.Format("{{\"AADError\":\"AADSTS50076\",\"Claims\":{0}}}", e.Claims);
        return SendErrorToClient(HttpStatusCode.Forbidden, null, responseMessage);
    }
    ```

9. ???????? `TODO3b` ? `TODO3c` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ???? ????? AAD ???????? ?? ??????? ???? ???? ??????????, ??????? ?? ??????????? ?? ????????????, ?? ????????????? ??????? (??? ??? ???? ????????), AAD ?????? ????????? "400 Bad Request" ? ??????? `AADSTS65001`. MSAL ?????? ?????????? **MsalUiRequiredException**, ????????? ??? ??????????. ?????? ?????? ??????? ????? `getAccessTokenAsync` ????????, ????????? ???????? `{ forceConsent: true }`.
    *  ???? ????? AAD ???????? ?? ??????? ???? ???? ?????????????? ??????????, AAD ?????? ????????? "400 Bad Request" ? ??????? `AADSTS70011`. MSAL ?????? ?????????? **MsalUiRequiredException**, ????????? ??? ??????????. ?????? ?????? ???????? ?? ???? ????????????.
    *  ?????? ???????? ??????????, ??? ??? ?????? 70011 ???????????? ? ? ?????? ???????, ? ?? ??????? ???????????? ? ???? ??????????, ?????? ????? ??? ???????? ?????? ????????????? ??????????. 
    *  ?????? **MsalUiRequiredException** ?????????? ?????? `SendErrorToClient`. ??? ???????????, ??? ???????? **ExceptionMessage**, ?????????? ?????????? ?? ??????, ????? ???????? ? HTTP-??????.
    *  ????????? ???, ??????? ? ???????? ???????? ????????? ?????????? `null`.

    ```csharp
    if ((e.Message.StartsWith("AADSTS65001"))
    || (e.Message.StartsWith("AADSTS70011: The provided value for the input parameter 'scope' is not valid.")))
    {
        return SendErrorToClient(HttpStatusCode.Forbidden, e, null);
    }
    ```

10. ???????? `TODO3d` ??????????? ???? ?????. ???????? ????????, ??? ??? ???????? ?????? ??????????, ? ?? ???????? ??? ? ??????????? HTTP-?????? ? ?????????? **HttpStatusCode.Forbidden** (401). ? ?????????? ASP.NET ?????????? ??????????? HTTP-????? ? ?????????? "500 Server Error".

    ```csharp
    else
    {
        throw e;
    }  
    ```

11. ???????? `TODO4` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ?????? `GraphApiHelper` ? `ODataHelper` ???????????? ? ?????? ?? ????? **Helpers**. ????? `OneDriveItem` ???????????? ? ????? ?? ????? **Models**. ? ???? ?????? ?? ???????????? ????????? ???????? ???? ???????, ??? ??? ??? ?? ????? ????????? ? ??????????? ? ??????? ?????.
    * ?????????????????? ????? ????, ???? ??????????? ? Microsoft Graph ?????? ????????????? ??????????? ??????, ??????? ? ???? ?????? ????????? ` $select` ? `$top`. ?????? ?? ??? ??????????, ??? ????? ?????? ???????? name, ?????? ? ??? ????????? ?????? ?????? ??? ???????? ????? ??? ??????.
    * ???? ???????????? ? Microsoft Graph ????? ??????????????, Microsoft Graph ?????????? ?????? "401 Unauthorized" ? ????? "InvalidAuthenticationToken". ASP.NET ????? ?????? ?????????? **RuntimeBinderException**. ??? ????? ??????????, ????? ???? ???????? ?????? ?????, ???? MSAL ?????? ????????????? ???????? ????? ???????. 

    ```csharp
    var fullOneDriveItemsUrl = GraphApiHelper.GetOneDriveItemNamesUrl("?$select=name&$top=3");
    IEnumerable<OneDriveItem> filesResult;
    try
    {
        filesResult = await ODataHelper.GetItems<OneDriveItem>(fullOneDriveItemsUrl, result.AccessToken);
    }
    catch (Microsoft.CSharp.RuntimeBinder.RuntimeBinderException e)
    {
        return SendErrorToClient(HttpStatusCode.Unauthorized, e, null);                    
    }
    ```

12. ???????? `TODO5` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????: 

    * ???? ??????????? ???? ??? ??????????? ?????? ???????? *name* ????????? OneDrive, Microsoft Graph ?????? ???????? ???????? *eTag* ??? ????????? OneDrive. ????? ????????? ?????????? ???????? ??????, ???????????? ???????, ??????????? ???? ??? ??????????? ??????????, ???????? ?????? ????? ?????????.
    * ?????? ?? ???? ?????? ? ????? OneDrive ???????????? ??????? ? ???? HTTP-?????? "200 OK".

    ```csharp
    List<string> itemNames = new List<string>();
    foreach (OneDriveItem item in filesResult)
    {
        itemNames.Add(item.Name);
    }

    var requestMessage = new HttpRequestMessage();
    requestMessage.SetConfiguration(new HttpConfiguration());
    var response = requestMessage.CreateResponse<List<string>>(HttpStatusCode.OK, itemNames); 
    return response;
    ```

13. ???????? ??????????? ???? ????? ??? ??????? Get. ??? ??? ????? ????? ?? ???? ????:  

    * ????? ???????? ??????? ?????????? ?? ?????????? ?? ??????? ???????. 
    * ???? ?????? ????? ???????? ???????? ??????????, ??????????? HttpError ??????? ?????????? ?? ?????????? ? ???????? **ExceptionMessage**.  
    * ???? ? ???? ?????????? ????? ???????? ???????? `null`, ??????????? HttpError ??????? ???????? message ? ???????? **Message**. ???????? **ExceptionMessage** ?? ?????.

    ```csharp
    private HttpResponseMessage SendErrorToClient(HttpStatusCode statusCode, Exception e, string message)
    {
        HttpError error;
        if (e != null)
        {
            error = new HttpError(e, true);
        }
        else
        {
            error = new HttpError(message);
        }
        var requestMessage = new HttpRequestMessage();
        var errorMessage = requestMessage.CreateErrorResponse(statusCode, error);
        return errorMessage;
    }        
    ```

## <a name="run-the-add-in"></a>?????? ??????????

1. ????????? ? ??????? ?????????? ?????? ? OneDrive, ????? ????? ???? ????????? ??????????.

1. ? Visual Studio ??????? ??????? F5. ????????? PowerPoint, ??? ?? ????? **???????** ???????? ?????? **SSO ASP.NET**.

1. ??????? ?????? **Show Add-in** (???????? ??????????) ? ???? ??????, ????? ??????? ???????????????? ????????? ?????????? ? ??????? ?????.

1. ??????? ?????? **Get My Files from OneDrive** (???????? ??? ????? ?? OneDrive). ???? ?? ?? ????? ? Office, ??? ????? ?????????? ?????.
    
    > [!NOTE]
    > ???? ????? ?? ????? ? Office, ????????? ?????? ?????????????, ? ?? ??????? ????????? ?? ???????? ????? ?????????? Office, Office ????? ?? ??????? ????????????? (???? ???? ???????, ??? ??? ??????? ??? PowerPoint). ???? ??? ??????????, ???????? ???? ??? ?????? Microsoft Graph ??? ??????? ?????? ??? ??????? ??????????????. ????? ???????? ?????, *???????? ??? ?????????? Office*, ?????? ??? ???????? ?????? **Get My Files from OneDrive** (???????? ??? ????? ?? OneDrive).

1. ????? ????? ??? ??????? ???????? ?????? ?????? ? ????? ?? OneDrive. ??? ????? ?????? ????? 15 ??????, ???????? ? ?????? ???.
