# <a name="authorize-external-services-in-your-office-add-in"></a>Авторизация внешних служб в надстройке Office

Популярные веб-службы, в том числе Office 365, Google, Facebook, LinkedIn, SalesForce и GitHub, позволяют разработчикам предоставлять пользователям доступ к их учетным записям в других приложениях. Благодаря этому вы можете включать эти службы в свои надстройки Office.

>**Примечание.** Если внешняя служба доступна через Microsoft Graph (Office 365 или OneDrive), можно использовать систему единого входа, описанную в статье [Включение единого входа для надстроек Office](http://dev.office.com/docs/add-ins/develop/sso-in-office-add-ins) и связанных с ней статьях. Методы, описанные в этой статье, лучше всего использовать для внешних служб, недоступных через Microsoft Graph. Однако их *можно* использовать для доступа к Microsoft Graph вместо системы единого входа. Например, для системы единого входа требуется серверный код, поэтому ее нельзя использовать с одностраничным приложением. Кроме того, система единого входа пока не поддерживается на всех платформах.

Стандартная платформа, позволяющая обеспечить доступ веб-приложения к веб-службе, — **OAuth 2.0**. В большинстве ситуаций не обязательно знать абсолютно все о работе платформы, чтобы использовать ее в своей надстройке. Доступно много библиотек, где эти сведения изложены вкратце.

Основной принцип работы OAuth заключается в том, что приложение может быть субъектом безопасности для самого себя (как пользователь или группа) и использовать собственное удостоверение и набор разрешений. В большинстве типичных сценариев, когда пользователь выполняет действие в надстройке Office, требующее вовлечения веб-службы, надстройка отправляет службе запрос на получение определенного набора разрешений для учетной записи пользователя. Затем служба предлагает пользователю предоставить надстройке эти разрешения. После предоставления разрешений служба отправляет надстройке небольшой зашифрованный *маркер доступа*. Надстройка может использовать службу, включая этот маркер во все свои запросы к API-интерфейсам службы. Но надстройка может действовать только в рамках разрешений, предоставленных ей пользователем. Кроме того, срок действия маркера ограничен указанным периодом времени.

Разные шаблоны OAuth (*потоки* или *типы предоставления*) предназначены для разных сценариев. Наиболее часто используются следующие два шаблона:

- **Неявный поток**. Обмен данными между надстройкой и веб-службой реализуется с помощью JavaScript на стороне клиента.
- **Поток кода авторизации**. Используется подключение типа *сервер-сервер* между веб-приложением надстройки и веб-службой. Следовательно, используется серверный код.

Поток OAuth предназначен для безопасной идентификации и авторизации приложения. В потоке кода авторизации вам предоставляется *секрет клиента*, который необходимо держать в тайне. Одностраничное приложение (SPA) не может защитить секрет, поэтому в таких приложениях рекомендуется использовать неявный поток.

Подробнее о преимуществах и недостатках неявного потока и потока кода авторизации читайте в разделах [Authorization Code](https://tools.ietf.org/html/rfc6749#section-1.3.1) и [Implicit](https://tools.ietf.org/html/rfc6749#section-1.3.2).

>**Примечание.** Вы также можете использовать службу-посредник, которая будет выполнять авторизацию и передавать маркер доступа надстройке. Подробная информация об этом сценарии приведена в разделе **Службы-посредники** далее в этой статье.

## <a name="using-the-implicit-flow-in-office-add-ins"></a>Использование неявного потока в надстройках Office
Узнать, поддерживает ли веб-служба неявный поток, можно из документации к ней. Если служба поддерживает неявный поток, можете использовать библиотеку JavaScript **Office-js-helpers** для автоматизации работы:

- [Office-js-helpers](https://github.com/OfficeDev/office-js-helpers)

Сведения о других библиотек, которые поддерживают неявный поток, см. в разделе **Библиотеки** далее в этой статье.

## <a name="using-the-authorization-code-flow-in-office-add-ins"></a>Использование потока кода авторизации в надстройках Office

Библиотеки, позволяющие реализовать поток кода авторизации, доступны для различных языков и платформ. Дополнительную информацию о некоторых из них см. в разделе **Библиотеки** далее в этой статье.

Ниже приведены примеры надстроек, использующих поток кода авторизации:

- [Office-Add-in-Nodejs-ServerAuth](https://github.com/OfficeDev/Office-Add-in-Nodejs-ServerAuth) (NodeJS)
- [PowerPoint-Add-in-Microsoft-Graph-ASPNET-InsertChart](https://github.com/OfficeDev/PowerPoint-Add-in-Microsoft-Graph-ASPNET-InsertChart) (ASP.NET MVC)

### <a name="relayproxy-functions"></a>Функции ретрансляторов и прокси-серверов

Вы можете использовать поток кода авторизации даже с веб-приложением без сервера. Для этого необходимо сохранить **идентификатор клиента** и **секрет клиента** в простой функции, размещенной в такой службе, как [Функции Azure](https://azure.microsoft.com/en-us/services/functions) или [Amazon Lambda](https://aws.amazon.com/lambda).
Функция обменивает тот или иной код на **маркер доступа** и ретранслирует его обратно клиенту. Безопасность этого метода зависит от того, насколько хорошо защищен доступ к функции.

Для использования такого метода надстройка показывает всплывающее окно с экраном входа в веб-службу (например, Google или Facebook). Когда пользователь входит и предоставляет надстройке разрешение на доступ к своим ресурсам в веб-службе, надстройка получает код, который затем отправляется веб-функции. Службы, описанные в разделе **Службы-посредники** далее в этой статье, используют схожий поток.

## <a name="libraries"></a>Библиотеки

Библиотеки доступны для многих языков и платформ, как для неявного потока, так и для потока кода авторизации. Некоторые из них универсальны, а другие предназначены для определенных веб-служб.

**Office 365 и другие службы, использующие Azure Active Directory в качестве поставщика авторизации**: [Библиотеки проверки подлинности Azure Active Directory](https://azure.microsoft.com/en-us/documentation/articles/active-directory-authentication-libraries/). Кроме того, доступна предварительная версия [библиотеки проверки подлинности (Майкрософт)](https://www.nuget.org/packages/Microsoft.Identity.Client).

Если вы используете **Google**, выполните на странице [GitHub.com/Google](https://github.com/google) поиск по запросу "auth" или названию языка. Имена почти всех соответствующих репозиториев представлены в формате `google-auth-library-[name of language]`.

Если вы используете **Facebook**, выполните на сайте [Facebook для разработчиков](https://developers.facebook.com) поиск по запросу "library" или "sdk".

Если вы ищете **общие библиотеки OAuth 2.0**, откройте страницу [Код OAuth](http://oauth.net/code/), которую обновляет рабочая группа IETF по OAuth. Эта страница содержит ссылки на библиотеки, рассчитанные на более десятка языков. Обратите внимание, что некоторые из этих библиотек предназначены для реализации службы, поддерживающей OAuth. На этой странице библиотеки, представляющие интерес для разработчиков надстроек, называются *клиентскими* библиотеками, так как веб-сервер является клиентом службы, поддерживающей OAuth.

## <a name="middleman-services"></a>Службы-посредники

Для выполнения авторизации надстройка может использовать службу-посредника, такую как OAuth.io или Auth0. Служба-посредник предоставляет маркеры доступа к популярным веб-службам и/или упрощает процесс входа в надстройку через социальные сети. Достаточно добавить совсем немного кода, чтобы надстройка могла использовать сценарий на стороне клиента или код на стороне сервера для подключения к службе-посреднику, которая будет отправлять ее необходимые маркеры. Весь код для реализации авторизации находится в службе-посреднике.

Примеры надстроек, использующих для авторизации службу-посредника:

- [Office-Add-in-Auth0](https://github.com/OfficeDev/Office-Add-in-Auth0) использует Auth0 для входа через Facebook, Google и учетные записи Майкрософт:

- [Office-Add-in-OAuth.io](https://github.com/OfficeDev/Office-Add-in-OAuth.io) использует OAuth.io для получения маркеров доступа из Facebook и Google.

## <a name="what-is-cors"></a>Что такое CORS?

CORS расшифровывается как [общий доступ к ресурсам независимо от источника](https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS) (Cross Origin Resource Sharing). Сведения об использовании CORS в надстройках см. в статье [Устранение в надстройках Office ограничений, вызванных принципом одинакового источника](http://dev.office.com/docs/add-ins/develop/addressing-same-origin-policy-limitations).
