# <a name="create-a-nodejs-office-add-in-that-uses-single-sign-on"></a>Создание надстройки Office на платформе Node.js с использованием единого входа

Ваша веб-надстройка Office может использовать процедуру входа в Office для авторизации пользователей в надстройке и Microsoft Graph. При этом им не потребуется входить повторно. Общие сведения см. в статье [Включение единого входа в надстройке Office](../develop/sso-in-office-add-ins.md).

Из этой статьи вы узнаете, как включить единый вход в надстройке, созданной с помощью Node.js и express. 

> **Примечание.** Аналогичная статья, посвященная надстройке на основе ASP.NET, — [Создание надстройки Office на платформе ASP.NET с использованием единого входа](../develop/create-sso-office-add-ins-aspnet.md).

## <a name="prerequisites"></a>Необходимые условия

* [Node и npm](https://nodejs.org/en/) версии 6.9.4 или выше.
* [Git Bash](https://git-scm.com/downloads) (или другой клиент git).
* TypeScript версии 2.2.2 или выше.
* Office 2016 (версия 1708, сборка 8424.nnnn) или более поздняя (эту версию подписки на Office 365 иногда называют "нажми и работай"). Чтобы скачать эту версию, вам может потребоваться принять участие в программе предварительной оценки Office. Дополнительные сведения см. в статье [Примите участие в программе предварительной оценки Office](https://products.office.com/en-us/office-insider?tab=tab-1).

## <a name="set-up-the-starter-project"></a>Настройка начального проекта

1. Клонируйте или скачайте репозиторий [Office Add-in NodeJS SSO](https://github.com/officedev/office-add-in-nodejs-sso). 


    > **Примечание.** Существует две версии примера. 
    > 
    > * В папке **Before** находится начальный проект. Пользовательский интерфейс и другие аспекты надстройки, не связанные непосредственно с единым входом и авторизацией, уже готовы. В последующих разделах этой статьи рассматривается доработка проекта. 
    > * Версия примера в папке **Completed** идентична надстройке, которую вы бы создали, выполнив процедуры из этой статьи, за тем исключением, что готовый проект содержит комментарии к коду. В них нет необходимости, если вы читаете эту статью. Чтобы использовать готовую версию, просто выполните действия, описанные в этой статье, но замените папку Before на папку Completed и пропустите разделы **Код на стороне клиента** и **Код на стороне сервера**.

1. Откройте консоль Git bash в папке **Before**.

2. Введите в консоли команду `npm install`, чтобы установить все зависимости, указанные в файле package.json.

3. Введите в консоли команду `npm run build `, чтобы выполнить сборку проекта. 
     > Примечание. Могут возникать ошибки сборки с сообщениями о том, что некоторые переменные объявлены, но не используются. Игнорируйте эти ошибки. Они возникают из-за того, что в версии примера из папки Before отсутствует код, который будет добавлен позже.

## <a name="register-the-add-in-with-azure-ad-v2-endpoint"></a>Регистрация надстройки в конечной точке Azure AD версии 2

1. Перейдите на страницу [https://apps.dev.microsoft.com](https://apps.dev.microsoft.com). 

1. Войдите в клиент Office 365, используя учетные данные администратора. Пример: MyName@contoso.onmicrosoft.com

1. Нажмите **Добавить приложение**.

1. Укажите имя приложения Office-Add-in-NodeJS-SSO и нажмите **Создать приложение**.

1. Когда откроется страница настройки, скопируйте и сохраните **идентификатор приложения**. Он понадобится вам позже. 

    > Примечание. Этот идентификатор представляет собой значение аудитории, используемое, когда другие приложения, например ведущее приложение Office (PowerPoint, Word, Excel и т. д.), пытаются получить авторизованный доступ к вашему приложению. Кроме того, он используется как идентификатор клиента, когда приложение, в свою очередь, пытается получить авторизованный доступ к Microsoft Graph.

1. В разделе **Секреты приложения** нажмите **Создать новый пароль**. Откроется всплывающее диалоговое окно с новым паролем (его также называют секретом приложения). *Сразу скопируйте пароль и сохраните его вместе с идентификатором приложения.* Он понадобится вам позже. Затем закройте диалоговое окно.

1. В разделе **Платформы** нажмите **Добавление платформы**. 

1. В открывшемся диалоговом окне выберите **Веб-API**.

1. Будет создан **URI идентификатора приложения** в формате "api://{GUID кода приложения}". Вставьте строку localhost:3000 между двойной косой чертой и GUID. Полный идентификатор должен выглядеть следующим образом: `api://localhost:3000/{App ID GUID}`. (Доменная часть имени в поле **Область** под **URI идентификатора приложения** автоматически изменится соответствующим образом. Она должна выглядеть так: `api://localhost:3000/{App ID GUID}/access_as_user`.)

1. Выполнив это и следующее действия, вы предоставите ведущему приложению Office доступ к надстройке. В разделе **Предварительно авторизованные приложения** укажите приложения, которые необходимо авторизовать для веб-приложения надстройки. Необходимо обеспечить предварительную авторизацию для всех указанных ниже идентификаторов. После ввода каждого из них будет появляться новое пустое текстовое поле. (Введите только GUID.)

 * `d3590ed6-52b3-4102-aeff-aad2292ab01c` (Microsoft Office).
 * `57fb890c-0dab-4253-a5e0-7188c88b2bb4` (Office Online).
 * `bc59ab01-8403-45c6-8796-ac3ef710b3e3` (Office Online). 

1. Откройте раскрывающийся список **Область** рядом с каждым полем **Идентификатор приложения** и установите флажок `api://localhost:44355/{App ID GUID}/access_as_user`.

1. В верхней части раздела **Платформы** снова нажмите кнопку **Добавление платформы** и выберите **Веб**.

1. В новом подразделе **Веб** раздела **Платформы** введите следующий **URL-адрес перенаправления**: `https://localhost:3000`. 

    > Примечание. На момент написания этой статьи платформа **Веб-API** иногда исчезает из раздела **Платформы**, особенно после обновления страницы после добавления платформы **Веб** *и сохранения страницы регистрации*. Чтобы убедиться, что платформа **Веб-API** все еще используется при регистрации, нажмите кнопку **Изменить манифест приложения** в нижней части страницы. В свойстве **identifierUris** манифеста должна отображаться строка `api://localhost:3000/{App ID GUID}`. Кроме того, должно отображаться свойство **oauth2Permissions**, для подсвойства **value** которого задано значение `access_as_user`.

1. Прокрутите вниз до подраздела **Делегированные разрешения** в разделе **Разрешения Microsoft Graph**. Нажмите кнопку **Добавить**, чтобы открыть диалоговое окно **Выбор разрешения**.

1. В диалоговом окне установите флажки следующих разрешений: 
    * Files.Read.All
    * profile

1. Нажмите **ОК** в нижней части диалогового окна.

1. Нажмите **Сохранить** в нижней части страницы регистрации.

## <a name="grant-admin-consent-to-the-add-in"></a>Предоставление надстройке согласия администратора

> **Примечание.** Эту процедуру необходимо выполнять только при разработке надстройки. После развертывания рабочей надстройки в Магазине Office или каталоге надстроек пользователи сделают ее доверенной в индивидуальном порядке во время установки.

1. В приведенной ниже строке замените заполнитель {application_ID} идентификатором приложения, скопированным во время регистрации надстройки.

    `https://login.microsoftonline.com/common/adminconsent?client_id={application_ID}&state=12345`

1. Вставьте полученный URL-адрес в адресную строку браузера и перейдите к нему.

1. Войдите в клиент Office 365, используя учетные данные администратора.

1. Затем вам будет предложено предоставить надстройке разрешение на доступ к данным Microsoft Graph. Нажмите **Принять**. 

1. После этого для окна или вкладки браузера будет выполнено перенаправление по **URL-адресу перенаправления**, указанному при регистрации надстройки. Если надстройка запущена, в браузере откроется ее домашняя страница. Если надстройка не запущена, возникнет ошибка и отобразится соответствующее сообщение о том, что не удается найти или открыть ресурс по адресу localhost:3000. *Однако сам факт попытки перенаправления свидетельствует о том, что согласие администратора успешно предоставлено*. Таким образом, независимо от того, открылась ли домашняя страница или возникла ошибка, вы можете переходить к следующему шагу.

2. В адресной строке браузера вы увидите параметр запроса tenant со значением GUID. Это идентификатор вашего клиента Office 365. Скопируйте и сохраните это значение. Оно понадобится вам позже.

3. Закройте окно или вкладку.

## <a name="configure-the-add-in"></a>Конфигурация надстройки

1. В редакторе кода откройте файл src\server.ts. В начале этого файла есть вызов конструктора класса `AuthModule`. У конструктора есть строковые параметры, которым необходимо назначить значения.

2. В свойстве `client_id` замените заполнитель `{client GUID}` на идентификатор приложения, сохраненный во время регистрации надстройки. В результате должен остаться только GUID в одиночных кавычках. Значение не должно содержать символов {}.

3. В свойстве `client_secret` замените заполнитель `{client secret}` на секрет приложения, сохраненный во время регистрации надстройки.

4. В свойстве `audience` замените заполнитель `{audience GUID}` на идентификатор приложения, сохраненный во время регистрации надстройки. (Это то же значение, которое вы назначили свойству `client_id`.)
  
3. В строке, назначенной свойству `issuer`, вы увидите заполнитель *{O365 tenant GUID}*. Замените его на идентификатор клиента Office 365, сохраненный в конце предыдущей процедуры. Если по той или иной причине вы не получили идентификатор ранее, используйте один из способов, описанных в статье [Поиск идентификатора клиента Office 365](https://support.office.com/en-us/article/Find-your-Office-365-tenant-ID-6891b561-a52d-4ade-9f39-b492285e2c9b). В результате значение свойства `issuer` должно выглядеть примерно так:

    `https://login.microsoftonline.com/12345678-1234-1234-1234-123456789012/v2.0`

1. Оставьте остальные параметры конструктора `AuthModule` без изменений. Сохраните и закройте файл.

1. В корневой папке проекта откройте файл манифеста Office-Add-in-NodeJS-SSO.xml.

1. Прокрутите вниз до конца файла.

1. Над последним тегом `</VersionOverrides>` вы найдете следующую разметку:

    ```xml
    <WebApplicationInfo>
      <Id>{application_GUID here}</Id>
      <Resource>api://localhost:3000/{application_GUID here}</Resource>
      <Scopes>
          <Scope>Files.Read.All</Scope>
          <Scope>profile</Scope>
      </Scopes>
    </WebApplicationInfo>
    ```

1. Замените заполнитель {application_GUID here} *в обоих местах* кода идентификатором приложения, скопированным во время регистрации надстройки. Символы {} не входят в состав идентификатора, их не нужно вставлять. Это тот же идентификатор, который использовался для ClientID и Audience в файле web.config.

    >Примечание. 
    >
    >* Значение **Resource** представляет собой **универсальный код ресурса (URI) идентификатора приложения**, который вы задали, когда добавляли платформу веб-API при регистрации надстройки.
    >* Раздел **Scopes** используется для создания диалогового окна согласия, только если надстройка продается в Магазине Office.

1. Сохраните и закройте файл.

## <a name="code-the-client-side"></a>Код на стороне клиента

1. Откройте файл program.js в папке **public**. В нем уже есть следующий код:

    * Назначение методу `Office.initialize`, которое, в свою очередь, назначает обработчик события для нажатия кнопки `getGraphAccessTokenButton`.
    * Метод `showResult` для отображения данных, возвращаемых из Microsoft Graph (или сообщения об ошибке), в нижней части области задач.

1. Под назначением методу `Office.initialize` добавьте приведенный ниже код. Вот что нужно знать об этом коде: 

    * Функция `getDataWithoutAuthChallenge` вызывается при первой попытке использовать поток "от имени". Предполагается, что однофакторной проверки подлинности достаточно. Позже вы добавите код для того случая, когда нужна многофакторная проверка подлинности.
    * `getAccessTokenAsync` — это новый API в Office.js, позволяющий надстройке запрашивать у ведущего приложения Office (Excel, PowerPoint, Word и т. д.) маркер доступа к надстройке (для пользователя, выполнившего вход в Office). Ведущее приложение Office, в свою очередь, запрашивает маркер у конечной точки Azure AD версии 2.0. Так как вы предварительно авторизовали ведущее приложение Office для надстройки во время ее регистрации, Azure AD отправит токен. 
     * Если вход в Office не выполнен, ведущее приложение Office предложит пользователю войти. 
     * Параметр настроек задает для свойства `forceConsent` значение false, поэтому пользователю не будет предложено разрешить ведущему приложению Office доступ к надстройке.

    ```js
    function getOneDriveItems() {
        getDataWithoutAuthChallenge();
    }   
    
    function getDataWithoutAuthChallenge() {       
        Office.context.auth.getAccessTokenAsync({forceConsent: false},
            function (result) {
                if (result.status === "succeeded") {
                    // TODO1: Use the access token to get Microsoft Graph data.
                }
                else {
                    console.log("Code: " + result.error.code);
                    console.log("Message: " + result.error.message);
                    console.log("name: " + result.error.name);
                    document.getElementById("getGraphAccessTokenButton").disabled = true;
                }
            });
    }
    ```

1. Замените TODO1 приведенными ниже строками. Метод `getData` и серверный маршрут "/api/onedriveitems" создаются позже. Для конечной точки используется относительный URL-адрес, так как она должна размещаться в том же домене, что и надстройка.

    ```
    accessToken = result.value;
    getData("/api/onedriveitems", accessToken);
    ```

1. Под методом `getOneDriveFiles` добавьте приведенный ниже код. Этот служебный метод вызывает указанную конечную точку веб-API и передает ей тот же маркер доступа, который ведущее приложение Office использовало для доступа к надстройке. На стороне сервера этот маркер доступа будет использоваться в потоке "от имени" для получения маркера доступа к Microsoft Graph. 

    ```
    function getData(relativeUrl, accessToken) {
        $.ajax({
            url: relativeUrl,
            headers: { "Authorization": "Bearer " + accessToken },
            type: "GET",
        })
        .done(function (result) {
            TODO2: Display data and handle demand for multi-factor authentication.
        })
        .fail(function (result) {
            console.log(result.error);
       });
    }
    ```

1. Замените строку TODO2 на приведенный ниже код. Вот что нужно знать об этом коде:
    * Если целевой объект Microsoft Graph запрашивает дополнительные факторы проверки подлинности, результат будет предоставлен не в виде данных. Он будет иметь формат JSON и включать в себя Claims, чтобы указать AAD, какие дополнительные факторы должен предоставить пользователь. В этом случае клиент должен заново выполнить вход для передачи строки Claims службе AAD, чтобы та отобразила необходимые запросы.
    * Если результат будет иметь формат JSON и включать в себя Claims, он будет содержать строку "capolids".
    * Вы создадите функцию `getDataUsingAuthChallenge` позже.

    ```
    if (result[0].indexOf('capolids') !== -1) {                
        result[0] = JSON.parse(result[0])
        getDataUsingAuthChallenge(result[0]);
    } else {  
        showResult(result);
    }
    ```

1. Добавьте указанную ниже функцию в файл сразу после функции `getData`. Обратите внимание на важные сведения об этой функции.
    * Эта функция используется, когда AAD запрашивает дополнительные факторы проверки подлинности. 
    * Эта функция инициирует повторный вход, во время которого пользователю необходимо будет предоставить дополнительные факторы проверки подлинности. 
    * Параметр `authChallenge` содержит строку, в которой AAD сообщается, какие факторы необходимо запросить. Ведущее приложение Office передает эту строку службе AAD, когда та запрашивает токен надстройки для вашей надстройки.

    ```
    function getDataUsingAuthChallenge(authChallengeString) {       
        Office.context.auth.getAccessTokenAsync({authChallenge: authChallengeString},
            function (result) {
                if (result.status === "succeeded") {
                    accessToken = result.value;
                    getData("/api/onedriveitems", accessToken);
                }
                else {
                    console.log("Code: " + result.error.code);
                    console.log("Message: " + result.error.message);
                    console.log("name: " + result.error.name);
                    document.getElementById("getGraphAccessTokenButton").disabled = true;
                }
            });
    }
    ```

1. Сохраните и закройте файл.

## <a name="code-the-server-side"></a>Код на стороне сервера

На стороне сервера необходимо изменить два файла. 
- Файл src\auth.js предоставляет вспомогательные функции авторизации. Он уже содержит универсальные элементы, используемые в различных потоках авторизации. Нам необходимо добавить в него функции, реализующие поток "от имени".
- Файл src\server.js содержит базовые элементы, необходимые для запуска сервера и ПО промежуточного слоя express. Нам необходимо добавить в него функции, предоставляющие домашнюю страницу, и веб-API для получения данных Microsoft Graph.

### <a name="create-a-method-to-exchange-tokens"></a>Создание метода для обмена маркерами

1. Откройте файл \src\auth.ts. Добавьте метод под классом `AuthModule`. Вот что нужно знать об этом коде:
    * Параметр jwt — это маркер доступа к приложению. В потоке "от имени" он отправляется службе AAD в обмен на маркер доступа к ресурсу.
    * Параметр scopes содержит значение по умолчанию, но в этом примере его переопределяет код вызова.
    * Указывать параметр resource не обязательно. Его не следует использовать, если службой токенов безопасности является конечная точка AAD версии 2. Последняя получает ресурс из областей и возвращает ошибку, если ресурс отправлен в HTTP-запросе. 
    

    ```
    private async exchangeForToken(jwt: string, scopes: string[] = ['openid'], resource?: string) {
        try {
            // TODO3: Construct the parameters that will be sent in the body of the 
            //        HTTP Request to the STS that starts the "on behalf of" flow.
            // TODO4: Send the request to the STS.
            // TODO5: Process the response and persist the access token to resource.
        }
        catch (exception) {
            throw new UnauthorizedError('Unable to obtain an access token to the resource' 
                                        + JSON.stringify(exception), 
                                        exception);
        }
    }
    ```

2. Замените TODO3 указанным ниже кодом. Вот что нужно знать об этом коде:
    * Служба токенов безопасности, поддерживающая поток "от имени", ожидает определенные пары "ключ-значение" в тексте HTTP-запроса. Этот код конструирует объект, который станет текстом запроса. 
    * Свойство ресурса добавляется в текст, только если методу был передан ресурс.

    ```
    const v2Params = {
            client_id: this.clientId,
            client_secret: this.clientSecret,
            grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
            assertion: jwt,
            requested_token_use: 'on_behalf_of',
            scope: scopes.join(' ')
        };
        let finalParams = {};
        if (resource) {
            // In JavaScript we could just add the resource property to the v2Params
            // object, but that won't compile in TypeScript.
            let v1Params  = { resource: resource };  
            for(var key in v2Params) { v1Params[key] = v2Params[key]; }
            finalParams = v1Params;
        } else {
            finalParams = v2Params;
        } 
    ```

3. Замените TODO4 указанным ниже кодом, который отправляет HTTP-запрос конечной точке маркера для службы токенов безопасности.

    ```
    const res = await fetch(`${this.stsDomain}/${this.tenant}/${this.tokenURLsegment}`, {
        method: 'POST',
        body: form(finalParams),
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    }); 
    ```

4. Замените TODO5 указанным ниже кодом. Обратите внимание, что код сохраняет маркер доступа для ресурса и срок его действия, а не только возвращает его. В коде вызова можно обойтись без лишних вызовов службы токенов безопасности, повторно используя действительный маркер доступа к ресурсу. В следующем разделе показано, как это сделать.

    ```
    if (res.status !== 200) {
        TODO6: Handle failure and the case where AAD asks for additional
               authentication factors.
    }
    const json = await res.json();
    // Persist the token and it's expiration time.
    const resourceToken = json['access_token'];
    ServerStorage.persist('ResourceToken', resourceToken);
    const expiresIn = json['expires_in'];  // seconds until token expires.
    const resourceTokenExpiresAt = moment().add(expiresIn, 'seconds');
    ServerStorage.persist('ResourceTokenExpiresAt', resourceTokenExpiresAt);
    return resourceToken; 
    ```

5. Замените TODO6 указанным ниже кодом. Вот что нужно знать об этом коде:

    * Существуют конфигурации Azure Active Directory, согласно которым пользователю необходимо предоставить дополнительные факторы проверки подлинности для доступа к некоторым целевым объектам Microsoft Graph (например, OneDrive), даже если пользователь может войти в Office, указав всего лишь пароль. В этом случае AAD отправит отклик, содержащий свойство `Claims`. 
    * Это значение `Claims` необходимо передать клиенту, который должен инициировать повторный вход пользователя и включить значение `Claims` в вызов AAD. AAD предложит пользователю предоставить дополнительные факторы.
    * В качестве меры предосторожности код очищает кэш всех маркеров доступа, полученных в случае, когда пользователь выполнял вход, указывая всего лишь пароль.  

    ```
    const exception = await res.json();
    // Check if AAD is the STS.
    if (this.stsDomain === 'https://login.microsoftonline.com') {
        if (JSON.stringify(exception.claims)) {                       
            ServerStorage.clear();
            return JSON.stringify(exception.claims);    
        } else {                    
            throw exception;
        }
    }
    else {                    
        throw exception;
    }
    ```

5. Сохраните файл, но не закрывайте его.

### <a name="create-a-method-to-get-access-to-the-resource-using-the-on-behalf-of-flow"></a>Создание метода для доступа к ресурсу с помощью потока "от имени"

1. В файле src/auth.ts добавьте метод под классом `AuthModule`. Вот что нужно знать об этом коде:
    * Приведенные выше комментарии к параметрам метода `exchangeForToken` также применимы к параметрам данного метода.
    * Метод сначала проверяет постоянное хранилище на наличие такого действительного маркера доступа к ресурсу, срок действия которого не истечет через минуту. Он вызывает метод `exchangeForToken`, создание которого описано в предыдущем разделе, только если это необходимо.

    ```
    async acquireTokenOnBehalfOf(jwt: string, scopes: string[] = ['openid'], resource?: string) {
        const resourceTokenExpirationTime = ServerStorage.retrieve('ResourceTokenExpiresAt');
        if (moment().add(1, 'minute').diff(resourceTokenExpirationTime) < 1 ) {
            return ServerStorage.retrieve('ResourceToken');
        } else if (resource) {
            return this.exchangeForToken(jwt, scopes, resource);
        } else {
            return this.exchangeForToken(jwt, scopes);
        }
    } 
    ```

2. Сохраните и закройте файл.

### <a name="create-the-endpoints-that-will-serve-the-add-ins-home-page-and-data"></a>Создание конечных точек, предоставляющих домашнюю страницу и данные надстройки

1. Откройте файл src\server.ts. 

2. Добавьте приведенный ниже метод в конец файла. Этот метод будет предоставлять домашнюю страницу надстройки. В манифесте надстройки указан URL-адрес домашней страницы.

    ```
    app.get('/index.html', handler(async (req, res) => {
        return res.sendfile('index.html');
    })); 
    ```

3. Добавьте приведенный ниже метод в конец файла. Этот метод будет обрабатывать все запросы к API `onedriveitems`.
    ```
    app.get('/api/onedriveitems', handler(async (req, res) => {
        // TODO7: Initialize the AuthModule object and validate the access token 
        //        that the client-side received from the Office host.
        // TODO8: Get a token to Microsoft Graph from either persistent storage 
        //        or the "on behalf of" flow.
        // TODO9: Use the token to get data from Microsoft Graph.
        // TODO10: Send to the client only the data that it actually needs.
    })); 
    ```

4. Замените TODO7 приведенным ниже кодом, который проверяет маркер доступа, полученный от ведущего приложения Office. Метод `verifyJWT` определен в файле src\auth.ts. Он всегда проверяет аудиторию и издателя. С помощью необязательного параметра мы указываем на необходимость проверить, указана ли в маркере доступа область `access_as_user`. Это единственное разрешение для надстройки, необходимое пользователю и ведущему приложению Office, чтобы получить маркер доступа к Microsoft Graph с помощью потока "от имени". 

    ```
    await auth.initialize();
    const { jwt } = auth.verifyJWT(req, { scp: 'access_as_user' }); 
    ```

> **Примечание.** Для авторизации API, который отвечает за поток выполнения от имени другого субъекта, в случае надстроек Office используйте только область `access_as_user`. Для других API в службе должны быть предусмотрены отдельные требования, касающиеся областей. Это ограничивает доступ, предоставляемый с использованием токенов, которые получает Office.

5. Замените TODO8 указанным ниже кодом. Обратите внимание на следующие особенности этого кода:

    * Данные вызова `acquireTokenOnBehalfOf` не включают параметр ресурса, так как мы создали объект `AuthModule` (`auth`) с использованием конечной точки AAD версии 2.0, которая не поддерживает свойство ресурса.
    * Второй параметр вызова задает разрешения, необходимые надстройке, чтобы получить список файлов и папок пользователя из OneDrive. (Разрешение `profile` не запрашивается, так как оно требуется, когда ведущее приложение Office получает маркер доступа к надстройке, а не когда вы меняете этот токен на маркер доступа к Microsoft Graph.)
    * Если отклик — строка, содержащая строку "capolids", значит, получено сообщение с утверждениями от AAD о необходимости выполнения многофакторной проверки подлинности. Это сообщение передается клиенту, который использует его для запуска повторного входа. Эта строка сообщает AAD, какие дополнительные факторы проверки подлинности необходимо запросить у пользователя.

    ```
    let graphToken = null;
    const tokenAcquisitionResponse = await auth.acquireTokenOnBehalfOf(jwt, ['Files.Read.All']);
    if (tokenAcquisitionResponse.includes('capolids')) {
        const claims: string[] = [];
        claims.push(tokenAcquisitionResponse);
        return res.json(claims);
    } else {
        // The response is the token to Microsoft Graph itself. Rename it so remaining code
        // is self-documenting.
        graphToken = tokenAcquisitionResponse;
    }
    ```

6. Замените TODO9 приведенной ниже строкой. Обратите внимание на следующие особенности этого кода:

    * Класс MSGraphHelper определен в файле src\msgraph-helper.ts. 
    * Чтобы сократить количество возвращаемых данных, мы указываем, что нас интересуют только первые 3 элемента и свойство name.

    `const graphData = await MSGraphHelper.getGraphData(graphToken, "/me/drive/root/children", "?$select=name&$top=3");`

7. Замените TODO10 приведенным ниже кодом. Обратите внимание, что Microsoft Graph возвращает некоторые метаданные OData и свойство **eTag** для каждого элемента, даже если запрашивается только свойство `name`. Код отправляет клиенту только имена элементов.

    ```
    const itemNames: string[] = [];
    const oneDriveItems: string[] = graphData['value'];
    for (let item of oneDriveItems){
        itemNames.push(item['name']);
    }
    return res.json(itemNames);
    ```

8. Сохраните и закройте файл.

## <a name="deploy-the-add-in"></a>Развертывание надстройки

Теперь необходимо сообщить Office, где находится надстройка.

1. Создайте сетевую папку или [предоставьте общий доступ к папке через сеть](https://technet.microsoft.com/en-us/library/cc770880.aspx).

2. Поместите копию файла манифеста Office-Add-in-NodeJS-SSO.xml из корневой папки проекта в общую папку.

3. Запустите PowerPoint и откройте документ.

4. Перейдите на вкладку **Файл**, а затем выберите **Параметры**.

5. Выберите **Центр управления безопасностью**, а затем нажмите кнопку **Параметры центра управления безопасностью**.

6. Выберите пункт **Доверенные каталоги надстроек**.

7. В поле **URL-адрес каталога** введите сетевой путь к общей папке с файлом Office-Add-in-NodeJS-SSO.xml и нажмите **Добавить каталог**.

8. Установите флажок **Показать в меню** и нажмите кнопку **ОК**.

9. Появится сообщение о том, что параметры будут применены при следующем запуске Microsoft Office. Закройте PowerPoint.

## <a name="build-and-run-the-project"></a>Сборка и запуск проекта

Выполнить сборку проекта и запустить его можно двумя способами в зависимости от того, используете ли вы Visual Studio Code. В обоих случаях при каждом изменении кода автоматически выполняется повторная сборка, после чего проект запускается.

1. Если вы не используете Visual Studio Code: 
 1. Откройте терминал node и перейдите к корневой папке проекта.
 2. Введите в терминале команду **npm run build**. 
 3. Откройте второй терминал node и перейдите к корневой папке проекта.
 4. Введите в терминале команду **npm run start**.

2. Если используется VS Code:
 1. Откройте проект в VS Code.
 2. Нажмите клавиши CTRL+SHIFT+B, чтобы выполнить сборку проекта.
 3. Нажмите клавишу F5, чтобы запустить проект в сеансе отладки.


## <a name="add-the-add-in-to-an-office-document"></a>Добавление надстройки в документ Office

1. Перезапустите PowerPoint и откройте или создайте презентацию. 

2. На вкладке **Разработчик** в PowerPoint выберите **Мои надстройки**.

3. Откройте вкладку **Общая папка**.

4. Выберите **SSO NodeJS Sample** и нажмите **ОК**.

5. На ленте **Главная** появится новая группа **SSO NodeJS** с кнопкой **Show Add-in** (Показать надстройку) и значком. 

## <a name="test-the-add-in"></a>Тестирование надстройки

1. Убедитесь в наличии нескольких файлов в OneDrive, чтобы можно было проверить результаты.

2. Нажмите кнопку **Show Add-in** (Показать надстройку), чтобы открыть надстройку.

2. Откроется страница приветствия. Нажмите кнопку **Get My Files from OneDrive** (Получить мои файлы из OneDrive).

2. Если вы вошли в Office, под кнопкой появится список ваших файлов и папок из OneDrive. В первый раз это может занять более 15 секунд.

3. Если вы не вошли в Office, откроется всплывающее окно с предложением войти. Список файлов и папок появится через несколько секунд после входа. *Повторно нажимать кнопку не требуется.*
> **Примечание.** Если вы ранее выполняли вход в Office с использованием другого идентификатора и все еще не закрыли некоторые из открытых тогда приложений Office, Office может не сменить идентификатор (даже если кажется, что это сделано для PowerPoint). Если это произойдет, возможен сбой при вызове Microsoft Graph или возврат данных для другого идентификатора. Чтобы избежать этого, *закройте все приложения Office*, прежде чем нажимать кнопку **Get My Files from OneDrive** (Получить мои файлы из OneDrive).
