---
title: ???????? ?????????? Office ?? ????????? Node.js ? ?????????????? ??????? ?????
description: 23.01.2018
ms.openlocfilehash: 4086471bec2ded671e1b3eafebc4fe69e9818344
ms.sourcegitcommit: c72c35e8389c47a795afbac1b2bcf98c8e216d82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/23/2018
---
# <a name="create-a-nodejs-office-add-in-that-uses-single-sign-on-preview"></a>???????? ?????????? Office ?? ????????? Node.js ? ?????????????? ??????? ????? (??????????????? ??????)

???? ???-?????????? Office ????? ???????????? ????????? ????? ? Office ??? ??????????? ????????????? ? ?????????? ? Microsoft Graph. ??? ???? ?? ?? ??????????? ??????? ????????. ????? ???????? ??. ? ?????? [????????? ??????? ????? ? ?????????? Office](sso-in-office-add-ins.md).

?? ???? ?????? ?? ???????, ??? ???????? ?????? ???? ? ??????????, ????????? ? ??????? Node.js ? Express. 

> [!NOTE]
> ??????????? ??????, ??????????? ?????????? ?? ?????? ASP.NET, ? [???????? ?????????? Office ?? ????????? ASP.NET ? ?????????????? ??????? ?????](create-sso-office-add-ins-aspnet.md).

## <a name="prerequisites"></a>??????????? ??????????

* [Node ? npm](https://nodejs.org/en/) ?????? 6.9.4 ??? ????? ???????.

* [Git Bash](https://git-scm.com/downloads) (??? ?????? ?????? git).

* TypeScript ?????? 2.2.2 ??? ????? ???????.

* Office 2016 ?????? 1708 (?????? 8424.nnnn) ??? ????? ??????? (?????? ???????? ?? Office 365, ?????? ?????????? "????? ? ???????").

  ??? ????????? ???? ?????? ????? ???????????? ???? ?????????? ????????? ??????????????? ?????? Office. ?????????????? ???????? ??. ? ?????? [??????? ??????? ? ????????? ??????????????? ?????? Office](https://products.office.com/en-us/office-insider?tab=tab-1).

## <a name="set-up-the-starter-project"></a>????????? ?????????? ???????

1. ?????????? ??? ???????? ??????????? [Office-Add-in-NodeJS-SSO](https://github.com/officedev/office-add-in-nodejs-sso). 

    > [!NOTE]
    > ?????????? ??? ?????? ???????.  
    > * ? ????? **Before** ????????? ????????? ??????. ???????????????? ????????? ? ?????? ??????? ??????????, ?? ????????? ??????????????? ? ?????? ?????? ? ????????????, ??? ??????. ? ??????????? ???????? ???? ?????? ??????????????? ????????? ???????. 
    > * ?????? ??????? ? ????? **Completed** ????????? ??????????, ??????? ?? ?? ???????, ???????? ????????? ?? ???? ??????, ?? ??? ???????????, ??? ??????? ?????? ???????? ??????????? ? ????. ? ??? ??? ?????????????, ???? ?? ??????? ??? ??????. ????? ???????????? ??????? ??????, ?????? ????????? ????????, ????????? ? ???? ??????, ?? ???????? ????? Before ?? ????? Completed ? ?????????? ??????? **??? ?? ??????? ???????** ? **??? ?? ??????? ???????**.

2. ???????? ??????? Git bash ? ????? **Before**.

3. ??????? ? ??????? ??????? `npm install`, ????? ?????????? ??? ???????????, ????????? ? ????? package.json.

4. ??????? ? ??????? ??????? `npm run build `, ????? ????????? ?????? ???????. 

    > [!NOTE]
    > ????? ????????? ?????? ?????? ? ??????????? ? ???, ??? ????????? ?????????? ?????????, ?? ?? ????????????. ??????????? ??? ??????. ??? ????????? ??-?? ????, ??? ? ???????? ?????? ??????? ??????????? ???, ??????? ????? ???????? ?????.

## <a name="register-the-add-in-with-azure-ad-v20-endpoint"></a>??????????? ?????????? ? ???????? ????? Azure AD ?????? 2.0

????????? ?????????? ???????? ????? ??????????, ??????? ?? ????? ???????????? ? ?????????? ??????. ??? ???? ?????? ???????? ?????????:
- ???????? ??????????? **$ADD-IN-NAME$** ?? `?Office-Add-in-NodeJS-SSO`.
- ???????? ??????????? **$FQDN-WITHOUT-PROTOCOL$** ?? `localhost:3000`.
- ??? ???????? ?????????? ? ?????????? ???? **????? ??????????** ?????????? ?????? ??? ????????? ??????????. ??? ????? ?????????? ????????? ?????? ?????? ??????????, ?? ?????????? `profile` ??????????, ????? ??????? ?????????? Office ???????? ?????? ??? ???-?????????? ??????????.
    * Files.Read.All
    * profile

[!INCLUDE[](../includes/register-sso-add-in-aad-v2-include.md)]


## <a name="grant-administrator-consent-to-the-add-in"></a>?????????????? ?????????? ???????? ??????????????

[!INCLUDE[](../includes/grant-admin-consent-to-an-add-in-include.md)]

## <a name="configure-the-add-in"></a>???????????? ??????????APPROVED

1. ? ????????? ???? ???????? ???? src\server.ts. ? ?????? ????? ????? ???? ????? ???????????? ?????? `AuthModule`. ? ???????????? ???? ????????? ?????????, ??????? ?????????? ????????? ????????.

2. ? ???????? `client_id` ???????? ??????????? `{client GUID}` ??????????????? ??????????, ??????????? ?? ????? ??????????? ??????????. ????? ?? ?????????, ?????? ???????? ?????? GUID ? ????????? ????????. ???????? ?? ?????? ????????? ???????? "{}".

3. ? ???????? `client_secret` ???????? ??????????? `{client secret}` ?? ?????? ??????????, ??????????? ?? ????? ??????????? ??????????.

4. ? ???????? `audience` ???????? ??????????? `{audience GUID}` ?? ????????????? ??????????, ??????????? ?? ????? ??????????? ??????????. (??? ?? ?? ????????, ??????? ?? ????????? ???????? `client_id`.)
  
3. ? ??????, ??????????? ???????? `issuer`, ?? ??????? ??????????? *{OID5  tenant GUID}*. ???????? ??? ??????????????? ?????? Office 365. ??? ??? ????????? ??????????? ???? ?? ????????, ????????? ? ?????? [????? ?????????????? ??????? Office 365](https://support.office.com/en-us/article/Find-your-Office-365-tenant-ID-6891b561-a52d-4ade-9f39-b492285e2c9b). ? ?????????? ???????? ???????? `issuer` ?????? ????????? ???????? ???:

    `https://login.microsoftonline.com/12345678-1234-1234-1234-123456789012/v2.0`

1. ???????? ????????? ????????? ???????????? `AuthModule` ??? ?????????. ????????? ? ???????? ????.

1. ? ???????? ????? ??????? ???????? ???? ????????? Office-Add-in-NodeJS-SSO.xml.

1. ?????????? ???? ?? ????? ?????.

1. ??? ????????? ????? `</VersionOverrides>` ?? ??????? ????????? ????????:

    ```xml
    <WebApplicationInfo>
      <Id>{application_GUID here}</Id>
      <Resource>api://localhost:3000/{application_GUID here}</Resource>
      <Scopes>
          <Scope>Files.Read.All</Scope>
          <Scope>profile</Scope>
      </Scopes>
    </WebApplicationInfo>
    ```

1. ???????? ??????????? {application_GUID here} *? ????? ??????* ???? ??????????????? ??????????, ????????????? ?? ????? ??????????? ??????????. (??????? "{}" ?? ???????? ?????? ??????????????, ??????? ?? ????? ?? ????????.) ??? ??? ?? ?????????????, ??????? ?? ???????????? ??? ClientID ? Audience ? ????? web.config.

    > [!NOTE]
    > * ???????? **Resource** ???????????? ????? **URI ?????????????? ??????????**, ??????? ?? ??????, ????? ????????? ????????? ???-API ??? ??????????? ??????????.
    > * ?????? **Scopes** ???????????? ??? ???????? ??????????? ???? ????????, ?????? ???? ?????????? ????????? ? AppSource.

1. ????????? ? ???????? ????.

## <a name="code-the-client-side"></a>??? ?? ??????? ???????

1. ???????? ???? program.js ? ????? **public**. ? ??? ??? ???? ????????? ???:

    * ?????????? ?????? `Office.initialize`, ???????, ? ???? ???????, ????????? ?????????? ??????? ??? ??????? ?????? `getGraphAccessTokenButton`.
    * ????? `showResult` ??? ??????????? ????????? ?? ?????? (??? ??????, ???????????? ?? Microsoft Graph) ? ?????? ????? ??????? ?????.
    * ????? `logErrors` ??? ??????????? ? ??????? ??????, ??????? ?? ????????????? ??? ????????????.

11. ????? ?????????? ??? ?????? `Office.initialize` ???????? ??????????? ???? ???. ??? ??? ????? ????? ?? ???? ????:

    * ??? ????????? ?????? ? ?????????? ?????? ????????????? ??????????? ??? ???? ??????? ???????? ?????? ??????? ? ??????? ??????? ?????? ??????????. ?????????? ???????? `timesGetOneDriveFilesHasRun`, ?????????? ????? `triedWithoutForceConsent` ? `timesMSGraphErrorReceived` ????????????, ????? ??? ???????????? ?? ??????????? ?????????? ????????? ??????? ???????? ??????. 
    * ????? `getDataWithToken` ????????? ?? ????????? ????. ???????? ???????? ?? ??, ??? ?? ??????????? ????????? `forceConsent` ???????? `false`. ?????????????? ???????? ??. ? ???????? ?????????? ????.

    ```javascript
    var timesGetOneDriveFilesHasRun = 0;
    var triedWithoutForceConsent = false;
    var timesMSGraphErrorReceived = false;

    function getOneDriveFiles() {
        timesGetOneDriveFilesHasRun++;
        triedWithoutForceConsent = true;
        getDataWithToken({ forceConsent: false });
    }   
    ```

1. ??? ??????? `getOneDriveFiles` ???????? ??????????? ???? ???. ??? ??? ????? ????? ?? ???? ????:

    * ? ??? ????? API ? Office.js, ??????????? ?????????? ??????????? ? ???????? ?????????? Office (Excel, PowerPoint, Word ? ?. ?.) ?????? ??????? ? ?????????? ??? ????????????, ????????? ? Office. ??????? ?????????? Office ??????????? ?????? ? ???????? ????? Azure AD 2.0. ??? ??? ?? ?????????????? ???????????? ??????? ?????????? Office ??? ?????????? ?? ????? ?? ???????????, Azure AD ???????? ??????.`getAccessTokenAsync`
    * ???? ???? ? Office ?? ????????, ??????? ?????????? Office ????????? ???????????? ?????.
    * ???????? ???????? ?????? ??? `forceConsent` ???????? `false`, ??????? ???????????? ?? ????? ???????????? ????????? ???????? ?????????? Office ?????? ? ?????????? ??? ?????? ?? ?????????????. ??? ?????? ??????? ?????????? ????? `getAccessTokenAsync` ?? ????? ????????, ?? ?????? ????????? ??????, ??????? ?? ???????? ?? ????????? ?????, ????????????? ???????? ????????? ?????, ??? ???? ????????? `forceConsent` ????? ?????? ???????? `true`, ? ???????????? ????? ?????????? ???????????. ????? ????????? ??????????? ?????? ? ?????? ???.
    * ?? ????????? ????? `handleClientSideErrors` ?????.

    ```javascript
    function getDataWithToken(options) {
    Office.context.auth.getAccessTokenAsync(options,
        function (result) {
            if (result.status === "succeeded") {
                TODO1: Use the access token to get Microsoft Graph data.
            }
            else {
                handleClientSideErrors(result);
            }
        });
    }
    ```

1. ???????? ?????? TODO1 ?? ??????????? ???? ??????. ????? `getData` ? ????????? ??????? /api/values ????????? ?????. ??? ???????? ????? ???????????? ????????????? URL-?????, ??? ??? ??? ?????? ??????????? ?? ??? ?? ??????, ??? ? ??????????.

    ```javascript
    accessToken = result.value;
    getData("/api/values", accessToken);
    ```

1. ??? ??????? `getOneDriveFiles` ???????? ??????????? ???? ???. ??? ??? ????? ????? ?? ???? ????:

    * ???? ????? ???????? ????????? ???????? ????? ???-API ? ???????? ?? ??? ?? ?????? ???????, ??????? ??????? ?????????? Office ???????????? ??? ??????? ? ??????????. ?? ??????? ??????? ???? ?????? ??????? ????? ?????????????? ? ?????? "?? ?????" ??? ????????? ??????? ??????? ? Microsoft Graph.
    * ?? ????????? ????? `handleServerSideErrors` ?????.

    ```javascript
    function getData(relativeUrl, accessToken) {
        $.ajax({
            url: relativeUrl,
            headers: { "Authorization": "Bearer " + accessToken },
            type: "GET"
        })
        .done(function (result) {
            showResult(result);
        })
        .fail(function (result) {
            handleServerSideErrors(result);
        }); 
    }
    ```

### <a name="create-the-error-handling-methods"></a>???????? ??????? ????????? ??????

1. ??? ??????? `getData` ???????? ??????????? ???? ?????. ???? ????? ????? ???????????? ?????? ? ??????? ??????????, ????? ??????? ?????????? Office ?? ?????? ???????? ?????? ??????? ? ???-?????? ??????????. ????????? ? ????? ??????? ???????? ??? ??????, ??????? ?????? ????? ????????? ?? ? ??????? ????????? `switch`.

    ```javascript
    function handleClientSideErrors(result) {

        switch (result.error.code) {
    
            // TODO2: Handle the case where user is not logged in, or the user cancelled, without responding, a
            //        prompt to provide a 2nd authentication factor. 
    
            // TODO3: Handle the case where the user's sign-in or consent was aborted.
    
            // TODO4: Handle the case where the user is logged in with an account that is neither work or school, 
            //        nor Micrososoft Account.
    
            // TODO5: Handle an unspecified error from the Office host.
    
            // TODO6: Handle the case where the Office host cannot get an access token to the add-ins 
            //        web service/application.
    
            // TODO7: Handle the case where the user tiggered an operation that calls `getAccessTokenAsync` 
            //        before a previous call of it completed.
    
            // TODO8: Handle the case where the add-in does not support forcing consent.
    
            // TODO9: Log all other client errors.
        }
    }
    ```

1. ???????? `TODO2` ??????????? ???? ?????. ?????? 13001 ?????????, ???? ???????????? ?? ???????? ???? ??? ??? ??????? ??????? ?????? ?? ?????????????? 2-?? ??????? ???????? ???????????. ? ????? ??????? ??? ???????? ????????? ????? `getDataWithToken` ? ?????? ???????? ??? ??????????????? ???????????? ?????.

    ```javascript
    case 13001:
        getDataWithToken({ forceAddAccount: true });
        break;
    ```

1. ???????? `TODO3` ??????????? ???? ?????. ?????? 13002 ?????????, ????? ???? ??? ?????????????? ?????????? ???????????. ????????? ???????????? ????????? ???????, ?? ?? ????? ?????? ????.

    ```javascript
    case 13002:
        if (timesGetOneDriveFilesHasRun < 2) {
            showResult(['Your sign-in or consent was aborted before completion. Please try that operation again.']);
        } else {
            logError(result);
        }          
        break; 
    ```

1. ???????? `TODO4` ??????????? ???? ?????. ?????? 13003 ?????????, ????? ???????????? ?????? ??? ??????? ???????, ???????? ?? ???????, ??????? ??? ?????? ??????? ?????? ??????????. ????????? ???????????? ?????, ? ????? ????? ? ??????? ??????? ?????? ??????????????? ????.

    ```javascript
    case 13003: 
        showResult(['Please sign out of Office and sign in again with a work or school account, or Microsoft Account. Other kinds of accounts, like corporate domain accounts do not work.']);
        break;   
    ```

    > [!NOTE]
    > ?????? 13004 ? 13005 ?? ?????????????? ??? ????????????? ????? ??????, ??? ??? ??? ?????? ????????? ?????? ?? ?????? ??????????. ?? ?????????? ????????? ? ??????? ???? ????? ??????????, ??????? ??? ?????? ???????? ? ??? ????????????.

1. ???????? `TODO5` ??????????? ???? ?????. ?????? 13006 ?????????, ???? ?????????? ?????????????? ?????? ???????? ?????????? Office, ??????? ????? ????????????????? ? ??? ???????????? ?????????. ????????? ???????????? ????????????? Office.

    ```javascript
    case 13006:
        showResult(['Please save your work, sign out of Office, close all Office applications, and restart this Office application.']);
        break;        
    ```

1. ???????? `TODO6` ??????????? ???? ?????. ?????? 13007 ?????????, ????? ?????????? ?????????????? ???????? ?????????? Office ? AAD, ??-?? ???? ??? ?????????? ?? ????? ???????? ?????? ??????? ? ???-??????/?????????? ??????????. ??? ????? ???? ??-?? ?????????? ???? ????. ????????? ???????????? ????????? ??????? ?????.

    ```javascript
    case 13007:
        showResult(['That operation cannot be done at this time. Please try again later.']);
        break;      
    ```

1. ???????? `TODO7` ??????????? ???? ?????. ?????? 13008 ?????????, ????? ???????????? ????????? ????????, ??????? ???????? `getAccessTokenAsync` ?? ?????????? ??????????? ??????.

    ```javascript
    case 13008:
        showResult(['Please try that operation again after the current operation has finished.']);
        break;
    ```      

1. ???????? `TODO8` ????????? ???? ?????. ?????? 13009 ?????????, ???? ?????????? ?? ???????????? ?????????????? ???????????? ??????????, ?? ??????????? ????? `getAccessTokenAsync` ? ?????????? ??? ????????? `forceConsent` ???????? `true`. ?????? ? ????? ?????? ??? ?????? ????????????? ???????? ????????? ????? `getAccessTokenAsync` ? ??????????, ??????? ???????? `false`. ?? ? ????????? ??????? ????? ?????? ? ?????????? ??? ????????? `forceConsent` ???????? `true` ??? ?? ???? ???????? ?????????????? ???????? ?? ?????? ?????? ?????? ? ?????????? ??? ????????? ???????? `false`. ? ???? ?????? ??? ?????? ?? ????????? ???????, ? ?????????? ???????????? ????? ? ????? ??????.

    ```javascript
    case 13009:
        if (triedWithoutForceConsent) {
            showResult(['Please sign out of Office and sign in again with a work or school account, or Microsoft Account.']);
        } else {
            getDataWithToken({ forceConsent: false });
        }
        break;
    ```      
    
1. ???????? `TODO9` ??????????? ???? ?????.

    ```javascript
    default:
        logError(result);
        break;
    ```  

1. ??? ??????? `handleClientSideErrors` ???????? ??????????? ???? ?????. ???? ????? ???????????? ?????? ? ???-?????? ?????????? ??? ???????????? ?????????? ?????? "?? ?????" ??? ????????? ?????? ?? Microsoft Graph.

    ```javascript
    function handleServerSideErrors(result) {
    
        // TODO10: Handle the case where AAD asks for an additional form of authentication.

        // TODO11: Handle the case where consent has not been granted, or has been revoked.

        // TODO12: Handle the case where an invalid scope (permission) was used in the on-behalf-of flow

        // TODO13: Handle the case where the token that the add-in's client-side sends to it's 
        //         server-side is not valid because it is missing `access_as_user` scope (permission).

        // TODO14: Handle the case where the token sent to Microsoft Graph in the request for 
        //         data is expired or invalid.

        // TODO15: Log all other server errors.
    }
    ```

1. ???????? `TODO10` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ?????????? ???????????? Azure Active Directory, ???????? ??????? ???????????? ?????????? ???????????? ?????????????? ??????? ???????? ??????????? ??? ??????? ? ????????? ??????? ???????? Microsoft Graph (????????, OneDrive), ???? ???? ???????????? ????? ????? ? Office, ?????? ????? ???? ??????. ? ????? ?????? AAD ???????? ??????, ?????????? ????? ?????? 50076 ?? ????????? `Claims`. 
    * ??????? ?????????? Office ?????? ???????? ????? ?????? ?? ????????? **Claims** ? ???????? ????????? `authChallenge`. ??? AAD ??????? ??????? ?????????? ??? ???????????? ?????? ?? ??????????? ???? ???? ???????? ???????????. 

    ```javascript
    if (result.responseJSON.error.innerError
            && result.responseJSON.error.innerError.error_codes
            && result.responseJSON.error.innerError.error_codes[0] === 50076){
        getDataWithToken({ authChallenge: result.responseJSON.error.innerError.claims });
    }
    ```

1. ???????? `TODO11` ??????????? ???? ????? *??????????????? ??? ????????? ??????????? ???????? ??????? ????, ??????? ?? ???????? ?? ?????????? ????*. ??? ??? ????? ????? ?? ???? ????:

    * ?????? 65001 ????????, ??? ?????? ? Microsoft Graph ?? ??? ???????????? (??? ??? ???????) ??? ?????? ??? ?????????? ??????????. 
    * ?????????? ?????? ???????? ????? ?????? (????????? `forceConsent` ?????? ???? ?????? ???????? `true`).

    ```javascript
    else if (result.responseJSON.error.innerError
            && result.responseJSON.error.innerError.error_codes
            && result.responseJSON.error.innerError.error_codes[0] === 65001){
        showResult(['Please grant consent to this add-in to access your Microsoft Graph data.']);        
        /*
            THE FORCE CONSENT OPTION IS NOT AVAILABLE IN DURING PREVIEW. WHEN SSO FOR
            OFFICE ADD-INS IS RELEASED, REMOVE THE showResult LINE ABOVE AND UNCOMMENT
            THE FOLLOWING LINE.
        */
        // getDataWithToken({ forceConsent: true });
    }
    ```

1. ???????? `TODO12` ??????????? ???? ????? *??????????????? ??? ????????? ??????????? ???????? ??????? ????, ??????? ?? ???????? ?? ?????????? ????*. ??? ??? ????? ????? ?? ???? ????:

    * ?????? 70011 ????????, ??? ????????? ???????????? ??????? (??????????). ?????????? ?????? ???????? ?? ??????.
    * ??? ???????????? ????? ?????? ?????? ? ??????? ?????? AAD.

    ```javascript
    else if (result.responseJSON.error.innerError
            && result.responseJSON.error.innerError.error_codes
            && result.responseJSON.error.innerError.error_codes[0] === 70011){
        showResult(['The add-in is asking for a type of permission that is not recognized.']);
    }
    ```

1. ???????? `TODO13` ??????????? ???? ????? *??????????????? ??? ????????? ??????????? ???????? ??????? ????, ??????? ?? ???????? ?? ?????????? ????*. ??? ??? ????? ????? ?? ???? ????:

    * ??? ?? ??????? ???????, ??????? ?? ????????? ?? ????? ??????? ?????, ???????? ?????????, ??????????????? ?? `... expected access_as_user`, ???? ??????? (??????????) `access_as_user` ????? ????????????? ? ??????? ???????, ???????????? ???????? ?????????? ? AAD ??? ????????????? ? ?????? "?? ?????".
    * ?????????? ?????? ???????? ?? ??????.

    ```javascript
    else if (result.responseJSON.error.name
            && result.responseJSON.error.name.indexOf('expected access_as_user') !== -1){
        showResult(['Microsoft Office does not have permission to get Microsoft Graph data on behalf of the current user.']);
    }
    ```

1. ???????? `TODO14` ??????????? ???? ????? *??????????????? ??? ????????? ??????????? ???????? ??????? ????, ??????? ?? ???????? ?? ?????????? ????*. ??? ??? ????? ????? ?? ???? ????:

    * ????????????, ????? ? Microsoft Graph ??? ????????? ???????????????? ?????? ??? ?????? ? ???????? ?????? ????????. ?? ???? ??? ??????????, ??? ?? ??????? ???????, ??????? ?? ????????? ?? ????? ??????? ?????, ????? ????????????? ??????? `Microsoft Graph error`.
    * ? ???? ?????? ?????????? ?????? ?????? ?????? ???? ??????? ???????? ???????????, ??????? ??????? `timesGetOneDriveFilesHasRun` ? ?????????? ????? `timesGetOneDriveFilesHasRun`, ? ????? ???????? ??????? ????? ??????????? ??????. ?? ??? ?????? ??????? ??? ?????? ???? ???. ???? ???????? ??????????, ?????????? ?????? ?????? ???????????????? ??????.
    * ??? ?????????????? ??????, ???? ??? ?????????? ??? ???? ??????.

    ```javascript
    else if (result.responseJSON.error.name
            && result.responseJSON.error.name.indexOf('Microsoft Graph error') !== -1) {
        if (!timesMSGraphErrorReceived) {
            timesMSGraphErrorReceived = true;
            timesGetOneDriveFilesHasRun = 0;
            triedWithoutForceConsent = false;
            getOneDriveFiles();
        } else {
            logError(result);
        }        
    }
    ```

1. ???????? `TODO15` ??????????? ???? ????? *??????????????? ??? ????????? ??????????? ???????? ??????? ????, ??????? ?? ???????? ?? ?????????? ?????*.

    ```javascript
    else {
        logError(result);
    }
    ```

## <a name="code-the-server-side"></a>??? ?? ??????? ???????

?? ??????? ??????? ?????????? ???????? ??? ?????. 
- ???? src\auth.js ????????????? ??????????????? ??????? ???????????. ?? ??? ???????? ????????????? ????????, ???????????? ? ????????? ??????? ???????????. ??? ?????????? ???????? ? ???? ???????, ??????????? ????? "?? ?????".
- ???? src\server.js ???????? ??????? ????????, ??????????? ??? ??????? ??????? ? ?? ?????????????? ???? express. ??? ?????????? ???????? ? ???? ???????, ??????????????? ???????? ????????, ? ???-API ??? ????????? ?????? Microsoft Graph.

### <a name="create-a-method-to-exchange-tokens"></a>???????? ?????? ??? ?????? ?????????

1. ???????? ???? \src\auth.ts. ???????? ??????????? ???? ????? ? ????? `AuthModule`. ??? ??? ????? ????? ?? ???? ????:

    * ???????? `jwt` ? ??? ?????? ??????? ? ??????????. ? ?????? "?? ?????" ?? ???????????? ?????? AAD ? ????? ?? ?????? ??????? ? ???????.
    * ???????? scopes ???????? ???????? ?? ?????????, ?? ? ???? ??????? ??? ?????????????? ??? ??????.
    * ????????? ???????? resource ?? ???????????. ??? ?? ??????? ????????????, ???? ??????? ??????? ???????????? ???????? ???????? ????? AAD ?????? 2.0. ???????? ????? ?????? 2.0 ???????? ?????? ?? ???????? ? ?????????? ??????, ???? ?????? ????????? ? HTTP-???????. 
    * ?????? ?????????? ? ????? `catch` *??* ???????? ? ??????????? ???????? ?????? "500 ?????????? ?????? ???????" ???????. ????? ???? ? ????? server.js ??????????? ?????? ?????????? ? ??????????? ??? ? ????????? ?? ??????, ???????????? ???????.

        ```javascript
        private async exchangeForToken(jwt: string, scopes: string[] = ['openid'], resource?: string) {
            try {
                // TODO3: Construct the parameters that will be sent in the body of the 
                //        HTTP Request to the STS that starts the "on behalf of" flow.
                // TODO4: Send the request to the STS.
                // TODO5: Catch errors from the STS and relay them to the client.
                // TODO6: Process the response and persist the access token to resource.
            }
            catch (exception) {
                throw new UnauthorizedError('Unable to obtain an access token to the resource' 
                                            + JSON.stringify(exception), 
                                            exception);
            }
        }
        ```

2. ???????? `TODO3` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:
    * ?????? ??????? ????????????, ?????????????? ????? "?? ?????", ??????? ???????????? ???? "????-????????" ? ?????? HTTP-???????. ???? ??? ???????????? ??????, ??????? ?????? ??????? ???????. 
    * ???????? ??????? ??????????? ? ?????, ?????? ???? ?????? ??? ??????? ??????.

        ```javascript
        const v2Params = {
                client_id: this.clientId,
                client_secret: this.clientSecret,
                grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                assertion: jwt,
                requested_token_use: 'on_behalf_of',
                scope: scopes.join(' ')
            };
            let finalParams = {};
            if (resource) {
                // In JavaScript we could just add the resource property to the v2Params
                // object, but that won't compile in TypeScript.
                let v1Params  = { resource: resource };  
                for(var key in v2Params) { v1Params[key] = v2Params[key]; }
                finalParams = v1Params;
            } else {
                finalParams = v2Params;
            } 
        ```

3. ???????? `TODO4` ??????????? ???? ?????, ??????? ?????????? HTTP-?????? ???????? ????? ??????? ??? ?????? ??????? ????????????.

    ```javascript
    const res = await fetch(`${this.stsDomain}/${this.tenant}/${this.tokenURLsegment}`, {
        method: 'POST',
        body: form(finalParams),
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    }); 
    ```

4. ???????? `TODO5` ??????????? ???? ?????. ???????? ???????? ?? ??, ??? ?????? ?????????? *??* ???????? ? ??????????? ???????? ?????? "500 ?????????? ?????? ???????" ???????. ????? ???? ? ????? server.js ??????????? ?????? ?????????? ? ??????????? ??? ? ????????? ?? ??????, ???????????? ???????.

    ```javascript
     if (res.status !== 200) {
        const exception = await res.json();
        throw exception;                
    } 
    ```

5. ???????? `TODO6` ??????????? ???? ?????. ???????? ???????? ?? ??, ??? ??? ????????? ?????? ??????? ??? ??????? ? ???? ??? ????????, ? ?? ?????? ?????????? ???. ? ???? ?????? ????? ???????? ??? ?????? ??????? ?????? ??????? ????????????, ???????? ????????? ?????????????? ?????? ??????? ? ???????. ? ????????? ??????? ????????, ??? ??? ???????.

    ```javascript  
    const json = await res.json();
    const resourceToken = json['access_token'];
    ServerStorage.persist('ResourceToken', resourceToken);
    const expiresIn = json['expires_in'];  // seconds until token expires.
    const resourceTokenExpiresAt = moment().add(expiresIn, 'seconds');
    ServerStorage.persist('ResourceTokenExpiresAt', resourceTokenExpiresAt);
    return resourceToken; 
    ```

6. ????????? ????, ?? ?? ?????????? ???.

### <a name="create-a-method-to-get-access-to-the-resource-using-the-on-behalf-of-flow"></a>???????? ?????? ??? ??????? ? ??????? ? ??????? ?????? "?? ?????"

1. ? ????? src/auth.ts ???????? ????? ??? ??????? `AuthModule`. ??? ??? ????? ????? ?? ???? ????:

    * ??????????? ???? ??????????? ? ?????????? ?????? `exchangeForToken` ????? ????????? ? ?????????? ??????? ??????.
    * ????? ??????? ????????? ?????????? ????????? ?? ??????? ??????????????? ??????? ??????? ? ???????, ???? ???????? ???????? ?? ??????? ????? ??????. ?? ???????? ????? `exchangeForToken`, ???????? ???????? ??????? ? ?????????? ???????, ?????? ???? ??? ??????????.

    ```javascript
    async acquireTokenOnBehalfOf(jwt: string, scopes: string[] = ['openid'], resource?: string) {
        const resourceTokenExpirationTime = ServerStorage.retrieve('ResourceTokenExpiresAt');
        if (moment().add(1, 'minute').diff(resourceTokenExpirationTime) < 1 ) {
            return ServerStorage.retrieve('ResourceToken');
        } else if (resource) {
            return this.exchangeForToken(jwt, scopes, resource);
        } else {
            return this.exchangeForToken(jwt, scopes);
        }
    } 
    ```

2. ????????? ? ???????? ????.

### <a name="create-the-endpoints-that-will-serve-the-add-ins-home-page-and-data"></a>???????? ???????? ?????, ??????????????? ???????? ???????? ? ?????? ??????????

1. ???????? ???? src\server.ts. 

2. ???????? ??????????? ???? ????? ? ????? ?????. ???? ????? ????? ????????????? ???????? ???????? ??????????. ? ????????? ?????????? ?????? URL-????? ???????? ????????.

    ```javascript
    app.get('/index.html', handler(async (req, res) => {
        return res.sendfile('index.html');
    })); 
    ```

3. ???????? ??????????? ???? ????? ? ????? ?????. ???? ????? ????? ???????????? ??? ??????? ? API `onedriveitems`.
    ```javascript
    app.get('/api/onedriveitems', handler(async (req, res) => {
        // TODO7: Initialize the AuthModule object and validate the access token 
        //        that the client-side received from the Office host.
        // TODO8: Get a token to Microsoft Graph from either persistent storage 
        //        or the "on behalf of" flow.
        // TODO9: Use the token to get data from Microsoft Graph.
        // TODO10: Relay any errors from Microsoft Graph to the client.
        // TODO11: Send to the client only the data that it actually needs.
    })); 
    ```

4. ???????? `TODO7` ??????????? ???? ?????, ??????? ????????? ?????? ???????, ?????????? ?? ???????? ?????????? Office. ????? `verifyJWT` ????????? ? ????? src\auth.ts. ?? ?????? ????????? ????????? ? ????????. ? ??????? ??????????????? ????????? ?? ????????? ?? ????????????? ???????? ????, ??????? ?? ? ??????? ??????? ??????? `access_as_user`. ??? ???????????? ?????????? ??? ??????????, ??????????? ???????????? ? ???????? ?????????? Office ??? ????, ????? ???????? ?????? ??????? ? Microsoft Graph ? ??????? ?????? "?? ?????". 

    ```javascript
    await auth.initialize();
    const { jwt } = auth.verifyJWT(req, { scp: 'access_as_user' }); 
    ```

    > [!NOTE]
    > ??? ??????????? API, ??????? ???????? ?? ????? "?? ?????", ? ?????? ????????? Office ??????????? ?????? ??????? `access_as_user`. ??? ?????? API ? ?????? ?????? ???? ????????????? ????????? ??????????, ?????????? ????????. ??? ???????????? ??? ????????, ? ??????? ???????????? ?????? ? ??????? ????????, ?????????? Office.

5. ???????? `TODO8` ??????????? ???? ?????. ???????? ???????? ?? ????????? ???? ??????????? ????? ????.

    * ?????? ?????? `acquireTokenOnBehalfOf` ?? ???????? ???????? ???????, ??? ??? ?? ??????? ?????? `AuthModule` (`auth`) ? ?????????????? ???????? ????? AAD ?????? 2.0, ??????? ?? ???????????? ???????? ???????.
    * ?????? ???????? ?????? ?????? ??????????, ??????????? ??????????, ????? ???????? ?????? ?????? ? ????? ???????????? ?? OneDrive. (?????????? `profile` ?? ?????????????, ??? ??? ??? ?????????, ????? ??????? ?????????? Office ???????? ?????? ??????? ? ??????????, ? ?? ????? ?? ??????? ???? ????? ?? ?????? ??????? ? Microsoft Graph.)

    ```javascript
    const graphToken = await auth.acquireTokenOnBehalfOf(jwt, ['Files.Read.All']);
    ```

6. ???????? `TODO9` ??????????? ???? ???????. ???????? ???????? ?? ????????? ???? ??????????? ????? ????.

    * ????? MSGraphHelper ????????? ? ????? src\msgraph-helper.ts. 
    * ????? ????????? ?????????? ???????????? ??????, ?? ?????????, ??? ??? ?????????? ?????? ?????? 3 ???????? ? ???????? name.

    `const graphData = await MSGraphHelper.getGraphData(graphToken, "/me/drive/root/children", "?$select=name&$top=3");`

7. ???????? `TODO10` ??????????? ???? ?????. ???????? ???????? ?? ??, ??? ???? ??? ???????????? ?????? "401 ?? ???????????????" Microsoft Graph, ??????? ????????? ?? ???????????????? ?????? ??? ?????? ? ???????? ?????? ????????. ??????????? ?????? ??????? ?????? ????, ??? ??? ??? ?????? ????????????? ?????? ?????????? ????????. (??. ?????? **???????? ?????? ??? ??????? ? ??????? ? ??????? ?????? "?? ?????"** ????.) ???? ??? ??????????, ??? ???????? ??????? ?????? ? ?????? "?????? Microsoft Graph". (??. ????? `handleClientSideErrors`, ????????? ???? ? ????? program.js ?? ????? ?? ????? ?????? ??????.) ???, ??????? ?? ???????? ? ???? ODataHelper.js ?? ????? ?? ????? ??????? ??????, ??????? ?????????? ?????? Microsoft Graph.

    ```javascript
    if (graphData.code) {
        if (graphData.code === 401) {
            throw new UnauthorizedError('Microsoft Graph error', graphData);
        }
    }
    ```


1. ???????? `TODO11` ??????????? ???? ?????. ???????? ???????? ?? ??, ??? Microsoft Graph ?????????? ????????? ?????????? OData ? ???????? **eTag** ??? ??????? ????????, ???? ???? ????????????? ?????? ???????? `name`. ??? ?????????? ??????? ?????? ????? ?????????.

    ```javascript
    const itemNames: string[] = [];
    const oneDriveItems: string[] = graphData['value'];
    for (let item of oneDriveItems){
        itemNames.push(item['name']);
    }
    return res.json(itemNames);
    ```

8. ????????? ? ???????? ????.

### <a name="add-response-handling-to-the-odatahelper"></a>?????????? ????????? ???????? ? ODataHelper

1. ???????? ???? src\odata-helper.ts. ???? ????? ????????. ??????????? ????? ????????? ?????? ??????????? ??? ??????? ?????????? ???????. ???????? `TODO` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ?????? ?? ???????? ????? OData ????? ???? ?????????? ?? ??????, ???????? 401, ???? ???????? ????? ??????????? ?????? ???????, ? ?? ?????????????? ??? ???? ??? ???????? ?????. ?? ????????? ?? ?????? ??-???????? ???????? *??????????*, ? ?? ??????? ?????? `https.get`, ??????? ?????? `on('error', reject)` ? ????? `https.get` ?? ???????????. ????? ???????, ??? ???????? ????????? ?? ???????? ?????????? (200) ?? ????????? ?? ??????? ? ?????????? ?????? JSON ?????????? ??????? ? ???????????? ??????? OData ??? ??????????? ?? ??????.

    ```javascript
    var error;
    if (response.statusCode === 200) {
        // TODO1: Return the data to the caller and resolve the Promise.
    } else {
       // TODO2: Return an error object to the caller and resolve the Promise.
    }
    ```

1.  ???????? `TODO1` ??????????? ???? ?????. ???????? ????????: ??? ????????????, ??? ?????? ???????????? ? ??????? JSON.

    ```javascript
    let parsedBody = JSON.parse(body);
    resolve(parsedBody);
    ```

1.  ???????? `TODO2` ??????????? ???? ?????. ??? ??? ????? ????? ?? ???? ????:

    * ?????? ? ?????????? ?? ?????? ?? ????????? OData ????? ????? ????????? statusCode ? statusMessage. ??? ???? ?????? ?? ??? ????? ?????????????? ??????, ? ?????? ? ??????. ????????? ????????? OData ????? ????????? ? ????? ???????? ?????? ? ??????????????? ??????????, ???????? ??????????? ??????? ??? ????????????????? ?????????? ? ?????.
    * ?????? Promise ????????, ?? ????????. ???????????, ???? ???-?????? ???????? ???????? ????? OData "??????-??????".`https.get` ?? ???? ????? ????????? ? ????????? ?????? ???????? ???-API ? ???-??????. ???? ???? "??????????" ?????? ????????, "???????" ??????, ???????????? ???????? ???-??????, ?? ???????????. ????? ????, ?????????? ????????? ?????? ? ???????????????? ???????? `Error`, ???? ???????, ?????????? `http.get`, ?????????? ???????? ??????? ????????? ?? ??????? ?? ???????? ????? OData.

    ```javascript
    error = new Error();
    error.code = response.statusCode;
    error.message = response.statusMessage;
    
    // The error body sometimes includes an empty space
    // before the first character, remove it or it causes an error.
    body = body.trim();
    error.bodyCode = JSON.parse(body).error.code;
    error.bodyMessage = JSON.parse(body).error.message;
    resolve(error);
    ```

1. ????????? ? ???????? ????.

## <a name="deploy-the-add-in"></a>????????????? ??????????

?????? ?????????? ???????? Office, ??? ????????? ??????????.

1. ???????? ??????? ????? ??? [???????????? ????? ?????? ? ????? ????? ????](https://technet.microsoft.com/en-us/library/cc770880.aspx).

2. ????????? ????? ????? ????????? Office-Add-in-NodeJS-SSO.xml ?? ???????? ????? ??????? ? ????? ?????.

3. ????????? PowerPoint ? ???????? ????????.

4. ????????? ?? ??????? **????**, ? ????? ???????? **?????????**.

5. ???????? **????? ?????????? ?????????????**, ? ????? ??????? ?????? **????????? ?????? ?????????? ?????????????**.

6. ???????? ????? **?????????? ???????? ?????????**.

7. ? ???? **URL-????? ????????** ??????? ??????? ???? ? ????? ????? ? ?????? Office-Add-in-NodeJS-SSO.xml ? ??????? **???????? ???????**.

8. ?????????? ?????? **???????? ? ????** ? ??????? ?????? **??**.

9. ???????? ????????? ? ???, ??? ????????? ????? ????????? ??? ????????? ??????? Microsoft Office. ???????? PowerPoint.

## <a name="build-and-run-the-project"></a>?????? ? ?????? ???????

????????? ?????? ??????? ? ????????? ??? ????? ????? ????????? ? ??????????? ?? ????, ??????????? ?? ?? Visual Studio Code. ? ????? ??????? ??? ?????? ????????? ???? ????????????? ??????????? ????????? ??????, ????? ???? ?????? ???????????.

1. ???? ?? ?? ??????????? Visual Studio Code: 
 1. ???????? ???????? node ? ????????? ? ???????? ????? ???????.
 2. ??????? ? ????????? ??????? **npm run build**. 
 3. ???????? ?????? ???????? node ? ????????? ? ???????? ????? ???????.
 4. ??????? ? ????????? ??????? **npm run start**.

2. ???? ???????????? VS Code:
 1. ???????? ?????? ? VS Code.
 2. ??????? ??????? CTRL+SHIFT+B, ????? ????????? ?????? ???????.
 3. ??????? ??????? F5, ????? ????????? ?????? ? ?????? ???????.


## <a name="add-the-add-in-to-an-office-document"></a>?????????? ?????????? ? ???????? Office

1. ????????????? PowerPoint ? ???????? ??? ???????? ???????????. 

2. ?? ??????? **???????????** ? PowerPoint ???????? **??? ??????????**.

3. ???????? ??????? **????? ?????**.

4. ???????? **SSO NodeJS Sample** ? ??????? **??**.

5. ?? ????? **???????** ???????? ????? ?????? **SSO NodeJS** ? ??????? **Show Add-in** (???????? ??????????) ? ???????. 

## <a name="test-the-add-in"></a>???????????? ??????????

1. ????????? ? ??????? ?????????? ?????? ? OneDrive, ????? ????? ???? ????????? ??????????.

2. ??????? ?????? **Show Add-in** (???????? ??????????), ????? ??????? ??????????.

2. ????????? ???????? ???????????. ??????? ?????? **Get my files from OneDrive** (???????? ??? ????? ?? OneDrive).

2. ???? ?? ????? ? Office, ??? ??????? ???????? ?????? ????? ?????? ? ????? ?? OneDrive. ? ?????? ??? ??? ????? ?????? ????? 15 ??????.

3. ???? ?? ?? ????? ? Office, ????????? ??????????? ???? ? ???????????? ?????. ?????? ?????? ? ????? ???????? ????? ????????? ?????? ????? ?????. *???????? ???????? ?????? ?? ?????????.*

> [!NOTE]
> ???? ?? ????? ????????? ???? ? Office ? ?????????????? ??????? ?????????????? ? ??? ??? ?? ??????? ????????? ?? ???????? ????? ?????????? Office, Office ????? ?? ??????? ????????????? (???? ???? ???????, ??? ??? ??????? ??? PowerPoint). ???? ??? ??????????, ???????? ???? ??? ?????? Microsoft Graph ??? ??????? ?????? ??? ??????? ??????????????. ????? ???????? ?????, *???????? ??? ?????????? Office*, ?????? ??? ???????? ?????? **Get My Files from OneDrive** (???????? ??? ????? ?? OneDrive).
